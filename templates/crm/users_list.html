{% extends "crm/base.html" %}
{% load static %}

{% block crm__page_header %}
    <h1 class="page-title">CRM Users List</h1>

    {% if can_edit %}
        <div>
            <a href="{% url 'crm:users_create' %}" class="btn btn--secondary">Add user</a>
        </div>
    {% endif %}
{% endblock %}

{% block crm__content %}
    <table class="crm-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Login</th>
                {% if can_edit %}
                <th colspan="2">Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="badge badge--{% if user.role == 'admin' %}danger{% elif user.role == 'operator' %}warning{% else %}secondary{% endif %}">
                            {{ user.role|default:"user"|title }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {% if user.is_active %}badge--success{% else %}badge--danger{% endif %}">
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td>{{ user.created_at|date:"Y-m-d"|default:"N/A" }}</td>
                    <td>{{ user.last_login|date:"Y-m-d H:i"|default:"Never" }}</td>
                    {% if can_edit %}
                        <td
                            {% if user.role == 'admin' %}
                            colspan="2"
                            {% endif %}
                        >
                            <a href="{% url 'crm:users_edit' user.id %}" class="btn btn--actions-primary">Edit</a>
                        </td>
                        {% if user.role != 'admin' and user.id != request.user.id %}
                            <td>
                                <form method="POST" class="delete-item" action="{% url 'crm:users_delete' user.id %}" onsubmit="return confirm('Are you sure you want to delete this user?');" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn--actions-secondary">Delete</button>
                                </form>
                            </td>
                        {% endif %}
                    {% endif %}
                </tr>
            {% empty %}
                <tr><td colspan="{% if can_edit %}7{% else %}6{% endif %}" class="empty">No users found</td></tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
