{"version":3,"names":[],"mappings":"","sources":["auth.js"],"sourcesContent":["import showNotification from \"./toast.js\";\nimport { env } from \"./env.js\";\n// ============ AUTH PAGE FUNCTIONALITY ============\n\n// Wait for DOM to be ready\ndocument.addEventListener('DOMContentLoaded', function() {\n    initAuthPage();\n});\n\n// Also run immediately if DOM is already loaded (for modules)\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initAuthPage);\n} else {\n    initAuthPage();\n}\n\nfunction initAuthPage() {\n    // Tab switching\n    const authTabs = document.querySelectorAll('.auth-tab');\n    const authContainers = document.querySelectorAll('.auth-form-container');\n\n    authTabs.forEach(tab => {\n        tab.addEventListener('click', () => {\n            const targetTab = tab.dataset.tab;\n            \n            // Remove active class from all tabs and containers\n            authTabs.forEach(t => t.classList.remove('active'));\n            authContainers.forEach(c => c.classList.remove('active'));\n            \n            // Add active class to clicked tab and corresponding container\n            tab.classList.add('active');\n            const targetContainer = document.getElementById(targetTab + 'Tab');\n            if (targetContainer) {\n                targetContainer.classList.add('active');\n            }\n        });\n    });\n\n    // Switch between login, register, forgot password, and reset password forms\n    const showRegisterBtn = document.getElementById('showRegister');\n    const showLoginBtn = document.getElementById('showLogin');\n    const showForgotPasswordBtn = document.getElementById('showForgotPassword');\n    const showLoginFromForgotBtn = document.getElementById('showLoginFromForgot');\n    const showLoginFromResetBtn = document.getElementById('showLoginFromReset');\n    const loginForm = document.getElementById('loginForm');\n    const registerForm = document.getElementById('registerForm');\n    const forgotPasswordForm = document.getElementById('forgotPasswordForm');\n    const resetPasswordForm = document.getElementById('resetPasswordForm');\n\n    // Helper function to hide all forms and show specific one\n    function showForm(formToShow) {\n        [loginForm, registerForm, forgotPasswordForm, resetPasswordForm].forEach(form => {\n            if (form) form.classList.remove('active');\n        });\n        if (formToShow) {\n            formToShow.classList.add('active');\n        }\n    }\n\n    if (showRegisterBtn) {\n        showRegisterBtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            showForm(registerForm);\n        });\n    }\n\n    if (showLoginBtn) {\n        showLoginBtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            showForm(loginForm);\n        });\n    }\n\n    if (showForgotPasswordBtn) {\n        showForgotPasswordBtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            console.log('Forgot password clicked, showing form');\n            if (forgotPasswordForm) {\n                showForm(forgotPasswordForm);\n            } else {\n                console.error('forgotPasswordForm not found');\n            }\n        });\n    }\n\n    if (showLoginFromForgotBtn) {\n        showLoginFromForgotBtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            showForm(loginForm);\n        });\n    }\n\n    if (showLoginFromResetBtn) {\n        showLoginFromResetBtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            showForm(loginForm);\n        });\n    }\n\n    // Check if reset token is in URL\n    const urlParams = new URLSearchParams(window.location.search);\n    const resetToken = urlParams.get('token');\n    if (resetToken && resetPasswordForm) {\n        // Set token in hidden input\n        const tokenInput = document.getElementById('reset-token');\n        if (tokenInput) {\n            tokenInput.value = resetToken;\n            showForm(resetPasswordForm);\n        }\n    }\n\n    // ============ USER LOGIN ============\n    const userLoginForm = document.getElementById('userLoginForm');\n    const loginSubmitBtn = document.getElementById('login-submit');\n\n    if (userLoginForm) {\n    userLoginForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(userLoginForm);\n        const username = formData.get('username');\n        const password = formData.get('password');\n        const remember = formData.get('remember');\n        \n        // Validate\n        if (!username || !password) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n\n        // Disable submit button\n        loginSubmitBtn.disabled = true;\n        loginSubmitBtn.innerText = 'Logging in...';\n\n        try {\n            const response = await fetch(`/api/user/auth/login/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({ username, password })\n            });\n            if (!response.ok) {\n                throw 'Login failed. Please check your credentials.'\n            }\n            \n            // Save user data\n            const userData = await response.json();\n            \n            if (remember) {\n                localStorage.setItem('user', JSON.stringify(userData.data));\n            } else {\n                sessionStorage.setItem('user', JSON.stringify(userData.data));\n            }\n            \n            showNotification('Login successful!', 'success');\n            console.log(userData);\n            \n            // Redirect to next URL or default to profile\n            const urlParams = new URLSearchParams(window.location.search);\n            const nextUrl = urlParams.get('next') || '/profile/';\n            \n            setTimeout(() => {\n                window.location.href = nextUrl;\n            }, 500);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            loginSubmitBtn.disabled = false;\n            loginSubmitBtn.innerText = 'Login';\n        }\n    });\n    }\n\n    // ============ USER REGISTRATION ============\n    const userRegisterForm = document.getElementById('userRegisterForm');\n    const regSubmitBtn = document.getElementById('reg-submit');\n\nif (userRegisterForm) {\n    userRegisterForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(userRegisterForm);\n        const username = formData.get('username');\n        const email = formData.get('email');\n        const password = formData.get('password');\n        const confirm = formData.get('confirm');\n        const terms = formData.get('terms');\n        \n        // Validate\n        if (!username || !email || !password || !confirm) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n        \n        if (password.length < 6) {\n            showNotification('Password must be at least 6 characters', 'error');\n            return;\n        }\n        \n        if (password !== confirm) {\n            showNotification('Passwords do not match', 'error');\n            return;\n        }\n        \n        if (!terms) {\n            showNotification('Please accept the terms and conditions', 'error');\n            return;\n        }\n\n        // Disable submit button\n        regSubmitBtn.disabled = true;\n        regSubmitBtn.innerText = 'Registering...';\n\n        try {\n            const resp = await fetch(`/api/user/auth/register/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({\n                    username,\n                    email,\n                    password,\n                    password_confirm: confirm,\n                })\n            });\n    \n            if (!resp.ok) {\n                throw 'Registration failed. Please check your credentials. Or try again later.'\n            }\n            \n            // Save user data\n            const userData = await resp.json();\n            \n            sessionStorage.setItem('user', JSON.stringify(userData.data));\n            \n            showNotification('Registration successful!', 'success');\n            console.log(userData);\n            \n            setTimeout(() => {\n                window.location.href = '/profile/';\n            }, 500);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            // Disable submit button\n            regSubmitBtn.disabled = false;\n            regSubmitBtn.innerText = 'Create Account';\n        }\n    });\n    }\n\n    // ============ ADMIN LOGIN ============\n    const adminLoginForm = document.getElementById('adminLoginForm');\n    const adminSubmitBtn = document.getElementById('admin-submit');\n\nif (adminLoginForm) {\n    adminLoginForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(adminLoginForm);\n        const username = formData.get('username');\n        const password = formData.get('password');\n        \n        // Validate\n        if (!username || !password) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n\n        adminSubmitBtn.disabled = true;\n        adminSubmitBtn.innerText = 'Logging in...';\n        \n        try {\n            const resp = await fetch(`/api/user/auth/login/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({\n                    username,\n                    password,\n                })\n            });\n            \n            if (!resp.ok) {\n                throw 'Login failed. Please check your credentials. Or try again later.'\n            }\n            \n            // Save admin data\n            const adminData = await resp.json();\n\n            if (adminData.data.user.role !== 'operator' && adminData.data.user.role !== 'admin') {\n                throw 'You are not authorized to access the admin panel.'\n            }\n            \n            sessionStorage.setItem('admin', JSON.stringify(adminData.data));\n            \n            showNotification('Login successful!', 'success');\n            \n            setTimeout(() => {\n                window.location.href = `/crm/`;\n            }, 500);\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            adminSubmitBtn.disabled = false;\n            adminSubmitBtn.innerText = 'Admin Login';\n        }\n    });\n    }\n\n    // ============ FORGOT PASSWORD ============\n    const forgotPasswordFormElement = document.getElementById('forgotPasswordFormElement');\n    const forgotSubmitBtn = document.getElementById('forgot-submit');\n\nif (forgotPasswordFormElement) {\n    forgotPasswordFormElement.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(forgotPasswordFormElement);\n        const emailOrUsername = formData.get('email_or_username');\n        \n        // Validate\n        if (!emailOrUsername) {\n            showNotification('Please enter your email or username', 'error');\n            return;\n        }\n\n        // Disable submit button\n        forgotSubmitBtn.disabled = true;\n        forgotSubmitBtn.innerText = 'Sending...';\n\n        try {\n            const response = await fetch(`/api/user/auth/forgot-password/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',\n                body: JSON.stringify({\n                    email: emailOrUsername.includes('@') ? emailOrUsername : null,\n                    username: emailOrUsername.includes('@') ? null : emailOrUsername\n                })\n            });\n            \n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw data.error || 'Failed to send reset link. Please try again.';\n            }\n            \n            showNotification(data.message || 'If an account exists, a password reset link has been sent.', 'success');\n            \n            // In development, show token if available\n            if (data.data && data.data.token) {\n                console.log('Reset Token (DEV):', data.data.token);\n                console.log('Reset URL (DEV):', data.data.reset_url);\n            }\n            \n            // Clear form\n            forgotPasswordFormElement.reset();\n            \n            // Optionally redirect to login after a delay\n            setTimeout(() => {\n                showForm(loginForm);\n            }, 2000);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            forgotSubmitBtn.disabled = false;\n            forgotSubmitBtn.innerText = 'Send Reset Link';\n        }\n    });\n    }\n\n    // ============ RESET PASSWORD ============\n    const resetPasswordFormElement = document.getElementById('resetPasswordFormElement');\n    const resetSubmitBtn = document.getElementById('reset-submit');\n\nif (resetPasswordFormElement) {\n    resetPasswordFormElement.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(resetPasswordFormElement);\n        const token = formData.get('token');\n        const newPassword = formData.get('new_password');\n        const confirmPassword = formData.get('confirm_password');\n        \n        // Validate\n        if (!token) {\n            showNotification('Reset token is missing', 'error');\n            return;\n        }\n        \n        if (!newPassword || !confirmPassword) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n        \n        if (newPassword.length < 6) {\n            showNotification('Password must be at least 6 characters', 'error');\n            return;\n        }\n        \n        if (newPassword !== confirmPassword) {\n            showNotification('Passwords do not match', 'error');\n            return;\n        }\n\n        // Disable submit button\n        resetSubmitBtn.disabled = true;\n        resetSubmitBtn.innerText = 'Resetting...';\n\n        try {\n            const response = await fetch(`/api/user/auth/reset-password/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',\n                body: JSON.stringify({\n                    token,\n                    new_password: newPassword,\n                    confirm_password: confirmPassword\n                })\n            });\n            \n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw data.error || 'Failed to reset password. Please try again.';\n            }\n            \n            showNotification(data.message || 'Password reset successfully!', 'success');\n            \n            // Clear form\n            resetPasswordFormElement.reset();\n            \n            // Redirect to login after a delay\n            setTimeout(() => {\n                showForm(loginForm);\n                // Remove token from URL\n                window.history.replaceState({}, document.title, window.location.pathname);\n            }, 1500);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            resetSubmitBtn.disabled = false;\n            resetSubmitBtn.innerText = 'Reset Password';\n        }\n    });\n    }\n\n    // ============ PASSWORD VISIBILITY TOGGLE ============\n    document.querySelectorAll('input[type=\"password\"]').forEach(input => {\n    const wrapper = input.parentElement;\n    const toggleBtn = document.createElement('button');\n    toggleBtn.type = 'button';\n    toggleBtn.innerHTML = `<i data-lucide=\"eye-off\" class='h-8 w-8'></i>`;\n    toggleBtn.style.cssText = `\n        position: absolute;\n        right: 15px;\n        top: 69%;\n        transform: translateY(-50%);\n        background: none;\n        border: none;\n        cursor: pointer;\n        opacity: 0.6;\n    `;\n    \n    wrapper.style.position = 'relative';\n    wrapper.appendChild(toggleBtn);\n\n    lucide.createIcons();\n    \n    toggleBtn.addEventListener('click', () => {\n        if (input.type === 'password') {\n            input.type = 'text';\n            toggleBtn.innerHTML = `<i data-lucide=\"eye\" class='h-8 w-8'></i>`;\n        } else {\n            input.type = 'password';\n            toggleBtn.innerHTML = `<i data-lucide=\"eye-off\" class='h-8 w-8'></i>`;\n        }\n\n        lucide.createIcons();\n    });\n    });\n}\n"],"file":"auth.js"}