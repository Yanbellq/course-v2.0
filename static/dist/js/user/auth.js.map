{"version":3,"names":[],"mappings":"","sources":["auth.js"],"sourcesContent":["import showNotification from \"./toast.js\";\nimport { env } from \"./env.js\";\n// ============ AUTH PAGE FUNCTIONALITY ============\n\n// Tab switching\nconst authTabs = document.querySelectorAll('.auth-tab');\nconst authContainers = document.querySelectorAll('.auth-form-container');\n\nauthTabs.forEach(tab => {\n    tab.addEventListener('click', () => {\n        const targetTab = tab.dataset.tab;\n        \n        // Remove active class from all tabs and containers\n        authTabs.forEach(t => t.classList.remove('active'));\n        authContainers.forEach(c => c.classList.remove('active'));\n        \n        // Add active class to clicked tab and corresponding container\n        tab.classList.add('active');\n        document.getElementById(targetTab + 'Tab').classList.add('active');\n    });\n});\n\n// Switch between login and register forms\nconst showRegisterBtn = document.getElementById('showRegister');\nconst showLoginBtn = document.getElementById('showLogin');\nconst loginForm = document.getElementById('loginForm');\nconst registerForm = document.getElementById('registerForm');\n\nif (showRegisterBtn) {\n    showRegisterBtn.addEventListener('click', () => {\n        loginForm.classList.remove('active');\n        registerForm.classList.add('active');\n    });\n}\n\nif (showLoginBtn) {\n    showLoginBtn.addEventListener('click', () => {\n        registerForm.classList.remove('active');\n        loginForm.classList.add('active');\n    });\n}\n\n// ============ USER LOGIN ============\nconst userLoginForm = document.getElementById('userLoginForm');\nconst loginSubmitBtn = document.getElementById('login-submit');\n\nif (userLoginForm) {\n    userLoginForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(userLoginForm);\n        const username = formData.get('username');\n        const password = formData.get('password');\n        const remember = formData.get('remember');\n        \n        // Validate\n        if (!username || !password) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n\n        // Disable submit button\n        loginSubmitBtn.disabled = true;\n        loginSubmitBtn.innerText = 'Logging in...';\n\n        try {\n            const response = await fetch(`/api/user/auth/login/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({ username, password })\n            });\n            if (!response.ok) {\n                throw 'Login failed. Please check your credentials.'\n            }\n            \n            // Save user data\n            const userData = await response.json();\n            \n            if (remember) {\n                localStorage.setItem('user', JSON.stringify(userData.data));\n            } else {\n                sessionStorage.setItem('user', JSON.stringify(userData.data));\n            }\n            \n            showNotification('Login successful!', 'success');\n            console.log(userData);\n            \n            // Redirect to next URL or default to profile\n            const urlParams = new URLSearchParams(window.location.search);\n            const nextUrl = urlParams.get('next') || '/profile/';\n            \n            setTimeout(() => {\n                window.location.href = nextUrl;\n            }, 500);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            loginSubmitBtn.disabled = false;\n            loginSubmitBtn.innerText = 'Login';\n        }\n    });\n}\n\n// ============ USER REGISTRATION ============\nconst userRegisterForm = document.getElementById('userRegisterForm');\nconst regSubmitBtn = document.getElementById('reg-submit');\n\nif (userRegisterForm) {\n    userRegisterForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(userRegisterForm);\n        const username = formData.get('username');\n        const email = formData.get('email');\n        const password = formData.get('password');\n        const confirm = formData.get('confirm');\n        const terms = formData.get('terms');\n        \n        // Validate\n        if (!username || !email || !password || !confirm) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n        \n        if (password.length < 6) {\n            showNotification('Password must be at least 6 characters', 'error');\n            return;\n        }\n        \n        if (password !== confirm) {\n            showNotification('Passwords do not match', 'error');\n            return;\n        }\n        \n        if (!terms) {\n            showNotification('Please accept the terms and conditions', 'error');\n            return;\n        }\n\n        // Disable submit button\n        regSubmitBtn.disabled = true;\n        regSubmitBtn.innerText = 'Registering...';\n\n        try {\n            const resp = await fetch(`/api/user/auth/register/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({\n                    username,\n                    email,\n                    password,\n                    password_confirm: confirm,\n                })\n            });\n    \n            if (!resp.ok) {\n                throw 'Registration failed. Please check your credentials. Or try again later.'\n            }\n            \n            // Save user data\n            const userData = await resp.json();\n            \n            sessionStorage.setItem('user', JSON.stringify(userData.data));\n            \n            showNotification('Registration successful!', 'success');\n            console.log(userData);\n            \n            setTimeout(() => {\n                window.location.href = '/profile/';\n            }, 500);\n\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            // Disable submit button\n            regSubmitBtn.disabled = false;\n            regSubmitBtn.innerText = 'Create Account';\n        }\n    });\n}\n\n// ============ ADMIN LOGIN ============\nconst adminLoginForm = document.getElementById('adminLoginForm');\nconst adminSubmitBtn = document.getElementById('admin-submit');\n\nif (adminLoginForm) {\n    adminLoginForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        const formData = new FormData(adminLoginForm);\n        const username = formData.get('username');\n        const password = formData.get('password');\n        \n        // Validate\n        if (!username || !password) {\n            showNotification('Please fill in all fields', 'error');\n            return;\n        }\n\n        adminSubmitBtn.disabled = true;\n        adminSubmitBtn.innerText = 'Logging in...';\n        \n        try {\n            const resp = await fetch(`/api/user/auth/login/`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                credentials: 'include',  // Важливо для cookies на Render\n                body: JSON.stringify({\n                    username,\n                    password,\n                })\n            });\n            \n            if (!resp.ok) {\n                throw 'Login failed. Please check your credentials. Or try again later.'\n            }\n            \n            // Save admin data\n            const adminData = await resp.json();\n\n            if (adminData.data.user.role !== 'operator' && adminData.data.user.role !== 'admin') {\n                throw 'You are not authorized to access the admin panel.'\n            }\n            \n            sessionStorage.setItem('admin', JSON.stringify(adminData.data));\n            \n            showNotification('Login successful!', 'success');\n            \n            setTimeout(() => {\n                window.location.href = `/crm/`;\n            }, 500);\n        } catch (error) {\n            showNotification(error, 'error');\n        } finally {\n            adminSubmitBtn.disabled = false;\n            adminSubmitBtn.innerText = 'Admin Login';\n        }\n    });\n}\n\n// ============ PASSWORD VISIBILITY TOGGLE ============\ndocument.querySelectorAll('input[type=\"password\"]').forEach(input => {\n    const wrapper = input.parentElement;\n    const toggleBtn = document.createElement('button');\n    toggleBtn.type = 'button';\n    toggleBtn.innerHTML = `<i data-lucide=\"eye-off\" class='h-8 w-8'></i>`;\n    toggleBtn.style.cssText = `\n        position: absolute;\n        right: 15px;\n        top: 69%;\n        transform: translateY(-50%);\n        background: none;\n        border: none;\n        cursor: pointer;\n        opacity: 0.6;\n    `;\n    \n    wrapper.style.position = 'relative';\n    wrapper.appendChild(toggleBtn);\n\n    lucide.createIcons();\n    \n    toggleBtn.addEventListener('click', () => {\n        if (input.type === 'password') {\n            input.type = 'text';\n            toggleBtn.innerHTML = `<i data-lucide=\"eye\" class='h-8 w-8'></i>`;\n        } else {\n            input.type = 'password';\n            toggleBtn.innerHTML = `<i data-lucide=\"eye-off\" class='h-8 w-8'></i>`;\n        }\n\n        lucide.createIcons();\n    });\n});\n"],"file":"auth.js"}