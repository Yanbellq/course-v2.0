{"version":3,"names":[],"mappings":"","sources":["crm.js"],"sourcesContent":["// static/src/js/crm/crm.js\r\n\r\nimport showNotification from \"../user/toast.js\";\r\n\r\n// ============ ADMIN LOGOUT FUNCTIONALITY ============\r\nasync function adminLogout() {\r\n    try {\r\n        const admin = sessionStorage.getItem('admin') || localStorage.getItem('admin');\r\n        \r\n        if (admin) {\r\n            const adminData = JSON.parse(admin);\r\n            \r\n            // Викликаємо logout endpoint\r\n            try {\r\n                await fetch('/api/user/auth/logout/', {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json',\r\n                        'Authorization': `Bearer ${adminData.tokens?.access || ''}`\r\n                    },\r\n                    credentials: 'include'\r\n                });\r\n            } catch (err) {\r\n                console.warn('Logout API call failed:', err);\r\n                // Продовжуємо навіть якщо API виклик не вдався\r\n            }\r\n        }\r\n        \r\n        // Видаляємо дані адміна зі storage\r\n        sessionStorage.removeItem('admin');\r\n        localStorage.removeItem('admin');\r\n        \r\n        // Видаляємо cookies (якщо є)\r\n        document.cookie.split(\";\").forEach(function(c) { \r\n            document.cookie = c.replace(/^ +/, \"\").replace(/=.*/, \"=;expires=\" + new Date().toUTCString() + \";path=/\"); \r\n        });\r\n        \r\n        showNotification('You have been logged out successfully', 'success');\r\n        \r\n        // Перенаправляємо на сторінку авторизації\r\n        setTimeout(() => {\r\n            window.location.href = '/auth/';\r\n        }, 500);\r\n        \r\n    } catch (error) {\r\n        console.error('Logout error:', error);\r\n        showNotification('Logout error', 'error');\r\n        \r\n        // Навіть при помилці видаляємо дані і перенаправляємо\r\n        sessionStorage.removeItem('admin');\r\n        localStorage.removeItem('admin');\r\n        setTimeout(() => {\r\n            window.location.href = '/auth/';\r\n        }, 1000);\r\n    }\r\n}\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n    // ============ DELETE FORMS ============\r\n    const deleteForms = document.querySelectorAll(\"form.delete-item\");\r\n\r\n    deleteForms.forEach((form) => {\r\n        form.addEventListener(\"submit\", async (e) => {\r\n            e.preventDefault();\r\n\r\n            const url = form.action;  // Django URL /crm/***/delete/ID/\r\n\r\n            const csrf = form.querySelector(\"input[name='csrfmiddlewaretoken']\")?.value;\r\n\r\n            try {\r\n                const response = await fetch(url, {\r\n                    method: \"POST\",\r\n                    credentials: \"include\",\r\n                    headers: {\r\n                        \"X-CSRFToken\": csrf,\r\n                        \"Accept\": \"application/json\",\r\n                    },\r\n                });\r\n\r\n                const data = await response.json();\r\n\r\n                if (data.success) {\r\n                    showNotification(\"Successfully deleted\");\r\n\r\n                    // Видаляємо HTML-рядок\r\n                    const row = form.closest(\"tr\");\r\n                    if (row) row.remove();\r\n                } else {\r\n                    showNotification(\"Delete error\", \"error\");\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Delete error:\", err);\r\n                showNotification(`Request error ${err}`, \"error\");\r\n            }\r\n        });\r\n    });\r\n    \r\n    // ============ ADMIN LOGOUT BUTTON ============\r\n    const adminLogoutBtn = document.getElementById('adminLogoutBtn');\r\n    if (adminLogoutBtn) {\r\n        adminLogoutBtn.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            adminLogout();\r\n        });\r\n    }\r\n});\r\n"],"file":"crm.js"}