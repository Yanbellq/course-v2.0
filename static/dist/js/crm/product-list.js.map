{"version":3,"names":[],"mappings":"","sources":["product-list.js"],"sourcesContent":["/**\r\n * Universal Product List Manager\r\n * Automatically initializes all product tables on the page\r\n */\r\n\r\n// Products data with prices\r\n// These variables are declared in the Django template before this script loads\r\n// We just reference them here - no need to redeclare\r\n// If they're not defined in template, they will be undefined and we'll handle that in the code\r\n\r\n/**\r\n * ProductListManager - Universal manager for product tables\r\n */\r\nclass ProductListManager {\r\n    constructor(config) {\r\n        this.config = {\r\n            tableBodyId: config.tableBodyId,\r\n            addButtonId: config.addButtonId,\r\n            totalDisplayId: config.totalDisplayId,\r\n            productSelectName: config.productSelectName || 'product_id[]',\r\n            quantityInputName: config.quantityInputName || 'quantity[]',\r\n            priceInputName: config.priceInputName || 'unit_price[]',\r\n            productsSource: config.productsSource || 'productsList', // 'productsList' or 'componentsData'\r\n            pricesSource: config.pricesSource || 'productsData', // 'productsData' or 'componentsData'\r\n            emptyMessage: config.emptyMessage || 'No products added yet',\r\n            emptyRowClass: config.emptyRowClass || 'empty-specifications',\r\n            ...config\r\n        };\r\n        \r\n        this.tableBody = document.getElementById(this.config.tableBodyId);\r\n        this.addButton = document.getElementById(this.config.addButtonId);\r\n        this.totalDisplay = document.getElementById(this.config.totalDisplayId);\r\n        \r\n        if (!this.tableBody) {\r\n            console.warn(`ProductListManager: Table body with ID \"${this.config.tableBodyId}\" not found`);\r\n            return;\r\n        }\r\n        \r\n        if (!this.addButton) {\r\n            console.warn(`ProductListManager: Add button with ID \"${this.config.addButtonId}\" not found`);\r\n        }\r\n        \r\n        if (!this.totalDisplay) {\r\n            console.warn(`ProductListManager: Total display with ID \"${this.config.totalDisplayId}\" not found`);\r\n        }\r\n        \r\n        this.init();\r\n    }\r\n    \r\n    init() {\r\n        // Add event listeners first\r\n        this.attachEventListeners();\r\n        \r\n        // Initialize existing rows\r\n        this.updateEmptyState();\r\n        \r\n        // Calculate initial subtotals for existing rows with data attributes\r\n        this.tableBody.querySelectorAll('.subtotal-display[data-quantity][data-price]').forEach(span => {\r\n            const quantity = parseFloat(span.dataset.quantity) || 0;\r\n            const price = parseFloat(span.dataset.price) || 0;\r\n            const subtotal = quantity * price;\r\n            span.textContent = '$' + subtotal.toFixed(2);\r\n        });\r\n        \r\n        // Calculate total after initialization\r\n        this.calculateTotal();\r\n    }\r\n    \r\n    attachEventListeners() {\r\n        // Listen for changes in quantity and price inputs\r\n        this.tableBody.addEventListener('input', (e) => {\r\n            if (e.target.name === this.config.quantityInputName || e.target.name === this.config.priceInputName) {\r\n                this.calculateTotal();\r\n            }\r\n        });\r\n        \r\n        // Listen for product select changes (works for both select and any element with matching name)\r\n        this.tableBody.addEventListener('change', (e) => {\r\n            if (e.target.tagName === 'SELECT' && e.target.name === this.config.productSelectName) {\r\n                this.updateUnitPrice(e.target);\r\n            }\r\n        });\r\n        \r\n        // Listen for remove button clicks (delegated event)\r\n        this.tableBody.addEventListener('click', (e) => {\r\n            if (e.target.classList.contains('remove-product') || e.target.closest('.remove-product')) {\r\n                const button = e.target.classList.contains('remove-product') ? e.target : e.target.closest('.remove-product');\r\n                const row = button.closest('tr');\r\n                if (row) {\r\n                    row.remove();\r\n                    this.updateEmptyState();\r\n                    this.calculateTotal();\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Add button click handler\r\n        if (this.addButton) {\r\n            this.addButton.addEventListener('click', (e) => {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n                this.addRow();\r\n            });\r\n        } else {\r\n            console.warn(`ProductListManager: Add button \"${this.config.addButtonId}\" not found, cannot add rows`);\r\n        }\r\n    }\r\n    \r\n    updateEmptyState() {\r\n        const productRows = this.tableBody.querySelectorAll('.product-row');\r\n        const emptyRow = this.tableBody.querySelector(`.${this.config.emptyRowClass}`);\r\n        \r\n        if (productRows.length === 0) {\r\n            // Show empty message if it doesn't exist\r\n            if (!emptyRow) {\r\n                const emptyTr = document.createElement('tr');\r\n                emptyTr.className = `specification-row ${this.config.emptyRowClass}`;\r\n                emptyTr.innerHTML = `<td colspan=\"5\">${this.config.emptyMessage}</td>`;\r\n                this.tableBody.appendChild(emptyTr);\r\n            }\r\n        } else {\r\n            // Hide empty message if products exist\r\n            if (emptyRow) {\r\n                emptyRow.remove();\r\n            }\r\n        }\r\n    }\r\n    \r\n    calculateSubtotal(row) {\r\n        const quantityInput = row.querySelector(`input[name=\"${this.config.quantityInputName}\"]`);\r\n        const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\r\n        const subtotalSpan = row.querySelector('.subtotal-display');\r\n        \r\n        if (quantityInput && priceInput && subtotalSpan) {\r\n            const quantity = parseFloat(quantityInput.value) || 0;\r\n            const price = parseFloat(priceInput.value) || 0;\r\n            const subtotal = quantity * price;\r\n            subtotalSpan.textContent = '$' + subtotal.toFixed(2);\r\n        }\r\n    }\r\n    \r\n    calculateTotal() {\r\n        const productRows = this.tableBody.querySelectorAll('.product-row');\r\n        let total = 0;\r\n        \r\n        productRows.forEach(row => {\r\n            const quantityInput = row.querySelector(`input[name=\"${this.config.quantityInputName}\"]`);\r\n            const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\r\n            \r\n            if (quantityInput && priceInput) {\r\n                const quantity = parseFloat(quantityInput.value) || 0;\r\n                const price = parseFloat(priceInput.value) || 0;\r\n                total += quantity * price;\r\n                this.calculateSubtotal(row);\r\n            }\r\n        });\r\n        \r\n        if (this.totalDisplay) {\r\n            this.totalDisplay.textContent = '$' + total.toFixed(2);\r\n        }\r\n        \r\n        // Auto-update additional field if configured (e.g., cost field, total_amount)\r\n        if (this.config.autoUpdateFieldId) {\r\n            const field = document.getElementById(this.config.autoUpdateFieldId);\r\n            if (field) {\r\n                field.value = total.toFixed(2);\r\n            }\r\n        }\r\n        \r\n        // Auto-update total_amount hidden field if it exists (for contracts, supplies, etc.)\r\n        const totalAmountField = document.getElementById('total_amount');\r\n        if (totalAmountField && !this.config.autoUpdateFieldId) {\r\n            totalAmountField.value = total.toFixed(2);\r\n        }\r\n    }\r\n    \r\n    updateUnitPrice(selectElement) {\r\n        const row = selectElement.closest('.product-row');\r\n        if (!row) return;\r\n        \r\n        const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\r\n        if (!priceInput) return;\r\n        \r\n        const productId = selectElement.value;\r\n        \r\n        let price = null;\r\n        \r\n        if (productId) {\r\n            // Try to get price from configured source\r\n            if (this.config.pricesSource === 'componentsData') {\r\n                if (typeof componentsData !== 'undefined' && Array.isArray(componentsData)) {\r\n                    const component = componentsData.find(c => String(c.id) === String(productId));\r\n                    if (component && component.price) {\r\n                        price = component.price;\r\n                    }\r\n                }\r\n            } else if (this.config.pricesSource === 'productsData') {\r\n                if (typeof productsData !== 'undefined') {\r\n                    price = productsData[productId];\r\n                }\r\n            }\r\n        }\r\n        \r\n        if (price !== null && price > 0) {\r\n            priceInput.value = price;\r\n        } else {\r\n            priceInput.value = '';\r\n        }\r\n        \r\n        this.calculateTotal();\r\n    }\r\n    \r\n    addRow() {\r\n        const row = document.createElement('tr');\r\n        row.className = 'product-row';\r\n        \r\n        // Get products source (variables are declared in template)\r\n        let productsSource;\r\n        if (this.config.productsSource === 'componentsData') {\r\n            productsSource = typeof componentsData !== 'undefined' ? componentsData : [];\r\n        } else {\r\n            productsSource = typeof productsList !== 'undefined' ? productsList : [];\r\n        }\r\n        \r\n        // Build options HTML\r\n        let optionsHTML = '<option value=\"\">Select product</option>';\r\n        if (productsSource && Array.isArray(productsSource)) {\r\n            productsSource.forEach(product => {\r\n                if (product && product.id && product.name) {\r\n                    optionsHTML += `<option value=\"${product.id}\">${product.name}</option>`;\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Determine placeholder text\r\n        const placeholder = this.config.productsSource === 'componentsData' ? 'Select component' : 'Select product';\r\n        optionsHTML = optionsHTML.replace('Select product', placeholder);\r\n        \r\n        row.innerHTML = `\r\n            <td>\r\n                <select name=\"${this.config.productSelectName}\" class=\"product-select\" required style=\"width: 100%; padding: 4px 8px;\">\r\n                    ${optionsHTML}\r\n                </select>\r\n            </td>\r\n            <td>\r\n                <input type=\"number\" name=\"${this.config.quantityInputName}\" min=\"1\" class=\"quantity-input\" value=\"1\" required style=\"width: 100%; padding: 4px 8px;\">\r\n            </td>\r\n            <td>\r\n                <input type=\"number\" name=\"${this.config.priceInputName}\" step=\"0.01\" min=\"0\" class=\"unit-price-input\" value=\"0\" required style=\"width: 100%; padding: 4px 8px;\">\r\n            </td>\r\n            <td>\r\n                <span class=\"subtotal-display\">$0.00</span>\r\n            </td>\r\n            <td style=\"text-align: center;\">\r\n                <button type=\"button\" class=\"btn btn--danger remove-product\" style=\"padding: 4px 8px;\">Ã—</button>\r\n            </td>\r\n        `;\r\n        \r\n        this.tableBody.appendChild(row);\r\n        this.updateEmptyState();\r\n        this.calculateTotal();\r\n    }\r\n}\r\n\r\n// Auto-initialize all product tables on page load\r\nfunction initProductListManagers() {\r\n    // Initialize products table (if exists)\r\n    if (document.getElementById('productsTableBody')) {\r\n        new ProductListManager({\r\n            tableBodyId: 'productsTableBody',\r\n            addButtonId: 'addProductBtn',\r\n            totalDisplayId: 'totalAmountDisplayFooter',\r\n            productSelectName: 'product_id[]',\r\n            quantityInputName: 'quantity[]',\r\n            priceInputName: 'unit_price[]',\r\n            productsSource: 'productsList',\r\n            pricesSource: 'productsData',\r\n            emptyMessage: 'No products added yet'\r\n        });\r\n    }\r\n    \r\n    // Initialize custom build products table (if exists)\r\n    if (document.getElementById('customBuildProductsTableBody')) {\r\n        new ProductListManager({\r\n            tableBodyId: 'customBuildProductsTableBody',\r\n            addButtonId: 'addCustomBuildProductBtn',\r\n            totalDisplayId: 'customBuildTotalDisplayFooter',\r\n            productSelectName: 'cb_product_id[]',\r\n            quantityInputName: 'cb_quantity[]',\r\n            priceInputName: 'cb_unit_price[]',\r\n            productsSource: 'componentsData',\r\n            pricesSource: 'componentsData',\r\n            emptyMessage: 'No components added yet'\r\n        });\r\n    }\r\n    \r\n    // Initialize products used table (if exists)\r\n    if (document.getElementById('productsUsedTableBody')) {\r\n        new ProductListManager({\r\n            tableBodyId: 'productsUsedTableBody',\r\n            addButtonId: 'addProductUsedBtn',\r\n            totalDisplayId: 'productsUsedTotalDisplay',\r\n            productSelectName: 'used_product_id[]',\r\n            quantityInputName: 'used_quantity[]',\r\n            priceInputName: 'used_unit_price[]',\r\n            productsSource: 'productsList',\r\n            pricesSource: 'productsData',\r\n            emptyMessage: 'No products added yet',\r\n            autoUpdateFieldId: 'cost' // Auto-update cost field\r\n        });\r\n    }\r\n    \r\n    // Initialize delivery products table (if exists) - for order total display only\r\n    // Check specifically for delivery form by looking for orderTotalDisplayFooter\r\n    const orderTotalDisplay = document.getElementById('orderTotalDisplayFooter');\r\n    if (orderTotalDisplay) {\r\n        const deliveryTableBody = document.getElementById('productsTableBody');\r\n        if (deliveryTableBody) {\r\n            // Listen for changes in quantity and price inputs to update order total\r\n            deliveryTableBody.addEventListener('input', (e) => {\r\n                if (e.target.name === 'quantity[]' || e.target.name === 'unit_price[]') {\r\n                    const productRows = deliveryTableBody.querySelectorAll('.product-row');\r\n                    let total = 0;\r\n                    \r\n                    productRows.forEach(row => {\r\n                        const quantityInput = row.querySelector('input[name=\"quantity[]\"]');\r\n                        const priceInput = row.querySelector('input[name=\"unit_price[]\"]');\r\n                        \r\n                        if (quantityInput && priceInput) {\r\n                            const quantity = parseFloat(quantityInput.value) || 0;\r\n                            const price = parseFloat(priceInput.value) || 0;\r\n                            total += quantity * price;\r\n                            \r\n                            // Update subtotal\r\n                            const subtotalSpan = row.querySelector('.subtotal-display');\r\n                            if (subtotalSpan) {\r\n                                subtotalSpan.textContent = '$' + (quantity * price).toFixed(2);\r\n                            }\r\n                        }\r\n                    });\r\n                    \r\n                    orderTotalDisplay.textContent = '$' + total.toFixed(2);\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Calculate initial subtotals for all existing rows with data attributes\r\n    document.querySelectorAll('.subtotal-display[data-quantity][data-price]').forEach(span => {\r\n        const quantity = parseFloat(span.dataset.quantity) || 0;\r\n        const price = parseFloat(span.dataset.price) || 0;\r\n        const subtotal = quantity * price;\r\n        span.textContent = '$' + subtotal.toFixed(2);\r\n    });\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', initProductListManagers);\r\n} else {\r\n    // DOM is already ready\r\n    initProductListManagers();\r\n}\r\n\r\n// Legacy functions for backward compatibility (if needed)\r\nfunction toggleCustomBuild() {\r\n    const checkbox = document.getElementById('has_custom_build');\r\n    const section = document.getElementById('custom_build_section');\r\n    if (checkbox && section) {\r\n        section.style.display = checkbox.checked ? 'block' : 'none';\r\n        if (checkbox.checked) {\r\n            setTimeout(() => {\r\n                const manager = window.productListManagers?.find(m => m.config.tableBodyId === 'customBuildProductsTableBody');\r\n                if (manager) manager.calculateTotal();\r\n            }, 100);\r\n        }\r\n    }\r\n}\r\n\r\nfunction toggleSoftwareService() {\r\n    const checkbox = document.getElementById('has_software_service');\r\n    const section = document.getElementById('software_service_section');\r\n    if (checkbox && section) {\r\n        section.style.display = checkbox.checked ? 'block' : 'none';\r\n    }\r\n}\r\n"],"file":"product-list.js"}