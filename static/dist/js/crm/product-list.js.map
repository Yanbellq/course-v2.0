{"version":3,"names":[],"mappings":"","sources":["product-list.js"],"sourcesContent":["/**\n * Universal Product List Manager\n * Automatically initializes all product tables on the page\n */\n\n// Products data with prices\n// These variables are declared in the Django template before this script loads\n// We just reference them here - no need to redeclare\n// If they're not defined in template, they will be undefined and we'll handle that in the code\n\n/**\n * ProductListManager - Universal manager for product tables\n */\nclass ProductListManager {\n    constructor(config) {\n        this.config = {\n            tableBodyId: config.tableBodyId,\n            addButtonId: config.addButtonId,\n            totalDisplayId: config.totalDisplayId,\n            productSelectName: config.productSelectName || 'product_id[]',\n            quantityInputName: config.quantityInputName || 'quantity[]',\n            priceInputName: config.priceInputName || 'unit_price[]',\n            productsSource: config.productsSource || 'productsList', // 'productsList' or 'componentsData'\n            pricesSource: config.pricesSource || 'productsData', // 'productsData' or 'componentsData'\n            emptyMessage: config.emptyMessage || 'No products added yet',\n            emptyRowClass: config.emptyRowClass || 'empty-specifications',\n            ...config\n        };\n        \n        this.tableBody = document.getElementById(this.config.tableBodyId);\n        this.addButton = document.getElementById(this.config.addButtonId);\n        this.totalDisplay = document.getElementById(this.config.totalDisplayId);\n        \n        if (!this.tableBody) {\n            console.warn(`ProductListManager: Table body with ID \"${this.config.tableBodyId}\" not found`);\n            return;\n        }\n        \n        if (!this.addButton) {\n            console.warn(`ProductListManager: Add button with ID \"${this.config.addButtonId}\" not found`);\n        }\n        \n        if (!this.totalDisplay) {\n            console.warn(`ProductListManager: Total display with ID \"${this.config.totalDisplayId}\" not found`);\n        }\n        \n        this.init();\n    }\n    \n    init() {\n        // Add event listeners first\n        this.attachEventListeners();\n        \n        // Initialize existing rows\n        this.updateEmptyState();\n        \n        // Calculate initial subtotals for existing rows with data attributes\n        this.tableBody.querySelectorAll('.subtotal-display[data-quantity][data-price]').forEach(span => {\n            const quantity = parseFloat(span.dataset.quantity) || 0;\n            const price = parseFloat(span.dataset.price) || 0;\n            const subtotal = quantity * price;\n            span.textContent = '$' + subtotal.toFixed(2);\n        });\n        \n        // Calculate total after initialization\n        this.calculateTotal();\n    }\n    \n    attachEventListeners() {\n        // Listen for changes in quantity and price inputs\n        this.tableBody.addEventListener('input', (e) => {\n            if (e.target.name === this.config.quantityInputName || e.target.name === this.config.priceInputName) {\n                this.calculateTotal();\n            }\n        });\n        \n        // Listen for product select changes (works for both select and any element with matching name)\n        this.tableBody.addEventListener('change', (e) => {\n            if (e.target.tagName === 'SELECT' && e.target.name === this.config.productSelectName) {\n                this.updateUnitPrice(e.target);\n            }\n        });\n        \n        // Listen for remove button clicks (delegated event)\n        this.tableBody.addEventListener('click', (e) => {\n            if (e.target.classList.contains('remove-product') || e.target.closest('.remove-product')) {\n                const button = e.target.classList.contains('remove-product') ? e.target : e.target.closest('.remove-product');\n                const row = button.closest('tr');\n                if (row) {\n                    row.remove();\n                    this.updateEmptyState();\n                    this.calculateTotal();\n                }\n            }\n        });\n        \n        // Add button click handler\n        if (this.addButton) {\n            this.addButton.addEventListener('click', (e) => {\n                e.preventDefault();\n                e.stopPropagation();\n                this.addRow();\n            });\n        } else {\n            console.warn(`ProductListManager: Add button \"${this.config.addButtonId}\" not found, cannot add rows`);\n        }\n    }\n    \n    updateEmptyState() {\n        const productRows = this.tableBody.querySelectorAll('.product-row');\n        const emptyRow = this.tableBody.querySelector(`.${this.config.emptyRowClass}`);\n        \n        if (productRows.length === 0) {\n            // Show empty message if it doesn't exist\n            if (!emptyRow) {\n                const emptyTr = document.createElement('tr');\n                emptyTr.className = `specification-row ${this.config.emptyRowClass}`;\n                emptyTr.innerHTML = `<td colspan=\"5\">${this.config.emptyMessage}</td>`;\n                this.tableBody.appendChild(emptyTr);\n            }\n        } else {\n            // Hide empty message if products exist\n            if (emptyRow) {\n                emptyRow.remove();\n            }\n        }\n    }\n    \n    calculateSubtotal(row) {\n        const quantityInput = row.querySelector(`input[name=\"${this.config.quantityInputName}\"]`);\n        const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\n        const subtotalSpan = row.querySelector('.subtotal-display');\n        \n        if (quantityInput && priceInput && subtotalSpan) {\n            const quantity = parseFloat(quantityInput.value) || 0;\n            const price = parseFloat(priceInput.value) || 0;\n            const subtotal = quantity * price;\n            subtotalSpan.textContent = '$' + subtotal.toFixed(2);\n        }\n    }\n    \n    calculateTotal() {\n        const productRows = this.tableBody.querySelectorAll('.product-row');\n        let total = 0;\n        \n        productRows.forEach(row => {\n            const quantityInput = row.querySelector(`input[name=\"${this.config.quantityInputName}\"]`);\n            const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\n            \n            if (quantityInput && priceInput) {\n                const quantity = parseFloat(quantityInput.value) || 0;\n                const price = parseFloat(priceInput.value) || 0;\n                total += quantity * price;\n                this.calculateSubtotal(row);\n            }\n        });\n        \n        if (this.totalDisplay) {\n            this.totalDisplay.textContent = '$' + total.toFixed(2);\n        }\n        \n        // Auto-update additional field if configured (e.g., cost field, total_amount)\n        if (this.config.autoUpdateFieldId) {\n            const field = document.getElementById(this.config.autoUpdateFieldId);\n            if (field) {\n                field.value = total.toFixed(2);\n            }\n        }\n        \n        // Auto-update total_amount hidden field if it exists (for contracts, supplies, etc.)\n        const totalAmountField = document.getElementById('total_amount');\n        if (totalAmountField && !this.config.autoUpdateFieldId) {\n            totalAmountField.value = total.toFixed(2);\n        }\n    }\n    \n    updateUnitPrice(selectElement) {\n        const row = selectElement.closest('.product-row');\n        if (!row) return;\n        \n        const priceInput = row.querySelector(`input[name=\"${this.config.priceInputName}\"]`);\n        if (!priceInput) return;\n        \n        const productId = selectElement.value;\n        \n        let price = null;\n        \n        if (productId) {\n            // Try to get price from configured source\n            if (this.config.pricesSource === 'componentsData') {\n                if (typeof componentsData !== 'undefined' && Array.isArray(componentsData)) {\n                    const component = componentsData.find(c => String(c.id) === String(productId));\n                    if (component && component.price) {\n                        price = component.price;\n                    }\n                }\n            } else if (this.config.pricesSource === 'productsData') {\n                if (typeof productsData !== 'undefined') {\n                    price = productsData[productId];\n                }\n            }\n        }\n        \n        if (price !== null && price > 0) {\n            priceInput.value = price;\n        } else {\n            priceInput.value = '';\n        }\n        \n        this.calculateTotal();\n    }\n    \n    addRow() {\n        const row = document.createElement('tr');\n        row.className = 'product-row';\n        \n        // Get products source (variables are declared in template)\n        let productsSource;\n        if (this.config.productsSource === 'componentsData') {\n            productsSource = typeof componentsData !== 'undefined' ? componentsData : [];\n        } else {\n            productsSource = typeof productsList !== 'undefined' ? productsList : [];\n        }\n        \n        // Build options HTML\n        let optionsHTML = '<option value=\"\">Select product</option>';\n        if (productsSource && Array.isArray(productsSource)) {\n            productsSource.forEach(product => {\n                if (product && product.id && product.name) {\n                    optionsHTML += `<option value=\"${product.id}\">${product.name}</option>`;\n                }\n            });\n        }\n        \n        // Determine placeholder text\n        const placeholder = this.config.productsSource === 'componentsData' ? 'Select component' : 'Select product';\n        optionsHTML = optionsHTML.replace('Select product', placeholder);\n        \n        row.innerHTML = `\n            <td>\n                <select name=\"${this.config.productSelectName}\" class=\"product-select\" required style=\"width: 100%; padding: 4px 8px;\">\n                    ${optionsHTML}\n                </select>\n            </td>\n            <td>\n                <input type=\"number\" name=\"${this.config.quantityInputName}\" min=\"1\" class=\"quantity-input\" value=\"1\" required style=\"width: 100%; padding: 4px 8px;\">\n            </td>\n            <td>\n                <input type=\"number\" name=\"${this.config.priceInputName}\" step=\"0.01\" min=\"0\" class=\"unit-price-input\" value=\"0\" required style=\"width: 100%; padding: 4px 8px;\">\n            </td>\n            <td>\n                <span class=\"subtotal-display\">$0.00</span>\n            </td>\n            <td style=\"text-align: center;\">\n                <button type=\"button\" class=\"btn btn--danger remove-product\" style=\"padding: 4px 8px;\">Ã—</button>\n            </td>\n        `;\n        \n        this.tableBody.appendChild(row);\n        this.updateEmptyState();\n        this.calculateTotal();\n    }\n}\n\n// Auto-initialize all product tables on page load\nfunction initProductListManagers() {\n    // Initialize products table (if exists)\n    if (document.getElementById('productsTableBody')) {\n        new ProductListManager({\n            tableBodyId: 'productsTableBody',\n            addButtonId: 'addProductBtn',\n            totalDisplayId: 'totalAmountDisplayFooter',\n            productSelectName: 'product_id[]',\n            quantityInputName: 'quantity[]',\n            priceInputName: 'unit_price[]',\n            productsSource: 'productsList',\n            pricesSource: 'productsData',\n            emptyMessage: 'No products added yet'\n        });\n    }\n    \n    // Initialize custom build products table (if exists)\n    if (document.getElementById('customBuildProductsTableBody')) {\n        new ProductListManager({\n            tableBodyId: 'customBuildProductsTableBody',\n            addButtonId: 'addCustomBuildProductBtn',\n            totalDisplayId: 'customBuildTotalDisplayFooter',\n            productSelectName: 'cb_product_id[]',\n            quantityInputName: 'cb_quantity[]',\n            priceInputName: 'cb_unit_price[]',\n            productsSource: 'componentsData',\n            pricesSource: 'componentsData',\n            emptyMessage: 'No components added yet'\n        });\n    }\n    \n    // Initialize products used table (if exists)\n    if (document.getElementById('productsUsedTableBody')) {\n        new ProductListManager({\n            tableBodyId: 'productsUsedTableBody',\n            addButtonId: 'addProductUsedBtn',\n            totalDisplayId: 'productsUsedTotalDisplay',\n            productSelectName: 'used_product_id[]',\n            quantityInputName: 'used_quantity[]',\n            priceInputName: 'used_unit_price[]',\n            productsSource: 'productsList',\n            pricesSource: 'productsData',\n            emptyMessage: 'No products added yet',\n            autoUpdateFieldId: 'cost' // Auto-update cost field\n        });\n    }\n    \n    // Initialize delivery products table (if exists) - for order total display only\n    // Check specifically for delivery form by looking for orderTotalDisplayFooter\n    const orderTotalDisplay = document.getElementById('orderTotalDisplayFooter');\n    if (orderTotalDisplay) {\n        const deliveryTableBody = document.getElementById('productsTableBody');\n        if (deliveryTableBody) {\n            // Listen for changes in quantity and price inputs to update order total\n            deliveryTableBody.addEventListener('input', (e) => {\n                if (e.target.name === 'quantity[]' || e.target.name === 'unit_price[]') {\n                    const productRows = deliveryTableBody.querySelectorAll('.product-row');\n                    let total = 0;\n                    \n                    productRows.forEach(row => {\n                        const quantityInput = row.querySelector('input[name=\"quantity[]\"]');\n                        const priceInput = row.querySelector('input[name=\"unit_price[]\"]');\n                        \n                        if (quantityInput && priceInput) {\n                            const quantity = parseFloat(quantityInput.value) || 0;\n                            const price = parseFloat(priceInput.value) || 0;\n                            total += quantity * price;\n                            \n                            // Update subtotal\n                            const subtotalSpan = row.querySelector('.subtotal-display');\n                            if (subtotalSpan) {\n                                subtotalSpan.textContent = '$' + (quantity * price).toFixed(2);\n                            }\n                        }\n                    });\n                    \n                    orderTotalDisplay.textContent = '$' + total.toFixed(2);\n                }\n            });\n        }\n    }\n    \n    // Calculate initial subtotals for all existing rows with data attributes\n    document.querySelectorAll('.subtotal-display[data-quantity][data-price]').forEach(span => {\n        const quantity = parseFloat(span.dataset.quantity) || 0;\n        const price = parseFloat(span.dataset.price) || 0;\n        const subtotal = quantity * price;\n        span.textContent = '$' + subtotal.toFixed(2);\n    });\n}\n\n// Initialize when DOM is ready\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initProductListManagers);\n} else {\n    // DOM is already ready\n    initProductListManagers();\n}\n\n// Legacy functions for backward compatibility (if needed)\nfunction toggleCustomBuild() {\n    const checkbox = document.getElementById('has_custom_build');\n    const section = document.getElementById('custom_build_section');\n    if (checkbox && section) {\n        section.style.display = checkbox.checked ? 'block' : 'none';\n        if (checkbox.checked) {\n            setTimeout(() => {\n                const manager = window.productListManagers?.find(m => m.config.tableBodyId === 'customBuildProductsTableBody');\n                if (manager) manager.calculateTotal();\n            }, 100);\n        }\n    }\n}\n\nfunction toggleSoftwareService() {\n    const checkbox = document.getElementById('has_software_service');\n    const section = document.getElementById('software_service_section');\n    if (checkbox && section) {\n        section.style.display = checkbox.checked ? 'block' : 'none';\n    }\n}\n"],"file":"product-list.js"}