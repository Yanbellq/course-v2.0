{"version":3,"names":[],"mappings":"","sources":["analytics.js"],"sourcesContent":["// Зберігаємо посилання на графіки\r\nlet revenueChart = null;\r\nlet categoryChart = null;\r\nlet repairChart = null;\r\nlet customerChart = null;\r\n\r\nasync function loadData() {\r\n    try {\r\n        // Отримуємо токен з cookies\r\n        const getCookie = (name) => {\r\n            const value = `; ${document.cookie}`;\r\n            const parts = value.split(`; ${name}=`);\r\n            if (parts.length === 2) return parts.pop().split(';').shift();\r\n            return null;\r\n        };\r\n        \r\n        const token = getCookie('access_token');\r\n        const headers = {\r\n            'Content-Type': 'application/json',\r\n        };\r\n        \r\n        if (token) {\r\n            headers['Authorization'] = `Bearer ${token}`;\r\n        }\r\n        \r\n        const res = await fetch(\"/api/analytics/\", {\r\n            method: 'GET',\r\n            headers: headers,\r\n            credentials: 'include'\r\n        });\r\n        \r\n        if (!res.ok) {\r\n            const errorData = await res.json().catch(() => ({}));\r\n            console.error(\"API Error:\", res.status, errorData);\r\n            throw new Error(`HTTP error! status: ${res.status}`);\r\n        }\r\n        const data = await res.json();\r\n\r\n        console.log(\"Analytics data received:\", data);\r\n        \r\n        // Завжди будуємо графіки, навіть якщо дані порожні\r\n        buildRevenueChart(data.revenue_months || [], data.revenue_values || []);\r\n        buildCategoryChart(data.category_labels || [], data.category_sales || []);\r\n        buildRepairChart(data.repair_labels || [], data.repair_counts || []);\r\n        buildCustomerChart(data.customer_labels || [], data.customer_counts || []);\r\n    } catch (error) {\r\n        console.error(\"Error loading analytics data:\", error);\r\n        // Показуємо порожні графіки\r\n        buildRevenueChart([], []);\r\n        buildCategoryChart([], []);\r\n        buildRepairChart([], []);\r\n        buildCustomerChart([], []);\r\n    }\r\n}\r\n\r\nfunction buildRevenueChart(labels, values) {\r\n    const ctx = document.getElementById(\"revenueChart\");\r\n    if (!ctx) {\r\n        console.warn(\"Revenue chart canvas not found\");\r\n        return;\r\n    }\r\n    \r\n    // Видаляємо старий графік, якщо він існує\r\n    if (revenueChart) {\r\n        revenueChart.destroy();\r\n    }\r\n    \r\n    revenueChart = new Chart(ctx, {\r\n        type: \"line\",\r\n        data: {\r\n            labels: labels || [],\r\n            datasets: [{\r\n                label: \"Revenue ($)\",\r\n                data: values || [],\r\n                borderColor: \"#000\",\r\n                borderWidth: 2,\r\n                fill: false,\r\n                tension: 0.1\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: true,\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction buildCategoryChart(labels, values) {\r\n    const ctx = document.getElementById(\"categoryChart\");\r\n    if (!ctx) {\r\n        console.warn(\"Category chart canvas not found\");\r\n        return;\r\n    }\r\n    \r\n    // Видаляємо старий графік, якщо він існує\r\n    if (categoryChart) {\r\n        categoryChart.destroy();\r\n    }\r\n    \r\n    categoryChart = new Chart(ctx, {\r\n        type: \"bar\",\r\n        data: {\r\n            labels: labels || [],\r\n            datasets: [{\r\n                label: \"Sales\",\r\n                data: values || [],\r\n                backgroundColor: \"#000\"\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: true,\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction buildRepairChart(labels, values) {\r\n    const ctx = document.getElementById(\"repairChart\");\r\n    if (!ctx) {\r\n        console.warn(\"Repair chart canvas not found\");\r\n        return;\r\n    }\r\n    \r\n    // Видаляємо старий графік, якщо він існує\r\n    if (repairChart) {\r\n        repairChart.destroy();\r\n    }\r\n    \r\n    repairChart = new Chart(ctx, {\r\n        type: \"bar\",\r\n        data: {\r\n            labels: labels || [],\r\n            datasets: [{\r\n                label: \"Repairs\",\r\n                data: values || [],\r\n                backgroundColor: \"#000\",\r\n                borderColor: \"#000\",\r\n                borderWidth: 1\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: true,\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nfunction buildCustomerChart(labels, values) {\r\n    const ctx = document.getElementById(\"customerChart\");\r\n    if (!ctx) {\r\n        console.warn(\"Customer chart canvas not found\");\r\n        return;\r\n    }\r\n    \r\n    // Видаляємо старий графік, якщо він існує\r\n    if (customerChart) {\r\n        customerChart.destroy();\r\n    }\r\n    \r\n    customerChart = new Chart(ctx, {\r\n        type: \"bar\",\r\n        data: {\r\n            labels: labels || [],\r\n            datasets: [{\r\n                label: \"New Customers\",\r\n                data: values || [],\r\n                backgroundColor: \"#000\"\r\n            }]\r\n        },\r\n        options: {\r\n            responsive: true,\r\n            maintainAspectRatio: true,\r\n            scales: {\r\n                y: {\r\n                    beginAtZero: true\r\n                }\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Wait for Chart.js to load and DOM to be ready\r\nlet waitAttempts = 0;\r\nconst MAX_WAIT_ATTEMPTS = 50; // Максимум 5 секунд (50 * 100ms)\r\n\r\nfunction waitForChart() {\r\n    waitAttempts++;\r\n    \r\n    if (waitAttempts > MAX_WAIT_ATTEMPTS) {\r\n        console.error(\"Chart.js failed to load after\", MAX_WAIT_ATTEMPTS * 100, \"ms\");\r\n        console.error(\"Chart.js available:\", typeof Chart !== 'undefined');\r\n        return;\r\n    }\r\n    \r\n    if (typeof Chart !== 'undefined') {\r\n        console.log(\"Chart.js loaded successfully\");\r\n        \r\n        // Перевіряємо, чи всі canvas елементи готові\r\n        const canvases = [\r\n            document.getElementById(\"revenueChart\"),\r\n            document.getElementById(\"categoryChart\"),\r\n            document.getElementById(\"repairChart\"),\r\n            document.getElementById(\"customerChart\")\r\n        ];\r\n        \r\n        const missingCanvases = canvases.filter(canvas => canvas === null);\r\n        \r\n        if (missingCanvases.length === 0) {\r\n            console.log(\"All canvas elements found, loading data...\");\r\n            loadData();\r\n        } else {\r\n            console.log(\"Waiting for canvas elements...\", missingCanvases.length, \"missing\");\r\n            // Якщо canvas ще не готові, чекаємо трохи\r\n            setTimeout(waitForChart, 100);\r\n        }\r\n    } else {\r\n        // Retry after a short delay\r\n        if (waitAttempts % 10 === 0) {\r\n            console.log(\"Waiting for Chart.js to load... attempt\", waitAttempts);\r\n        }\r\n        setTimeout(waitForChart, 100);\r\n    }\r\n}\r\n\r\nif (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', function() {\r\n        console.log(\"DOM loaded, waiting for Chart.js...\");\r\n        waitForChart();\r\n    });\r\n} else {\r\n    console.log(\"DOM already ready, waiting for Chart.js...\");\r\n    waitForChart();\r\n}\r\n\r\n"],"file":"analytics.js"}