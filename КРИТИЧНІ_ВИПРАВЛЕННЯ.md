# –ö—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–µ–∫—Ç—É: –§–æ–∫—É—Å –Ω–∞ –∫–æ–¥

> **–í–ê–ñ–õ–ò–í–û:** –¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –º—ñ—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º —É –∫–æ–¥—ñ. –í—Å—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ –∫–æ–¥—É –∞–¥–∞–ø—Ç–æ–≤–∞–Ω—ñ –ø—ñ–¥ —ñ—Å–Ω—É—é—á—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç—É —Ç–∞ ORM.

## üìã –®–í–ò–î–ö–ò–ô –ü–Ü–î–°–£–ú–û–ö

### –ö—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏:
1. **‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ 10 –∑–∞–ø–∏—Ç—ñ–≤ –∑ —Ç–µ–º–∏** - –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ `apps/api/views/queries_views.py` —Ç–∞ URLs
2. **‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ–π –µ–∫—Ä–∞–Ω –º–∞–Ω—ñ–ø—É–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏–º–∏** - –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ `apps/api/views/query_executor_views.py`
3. **‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É** - –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ —Ä–æ–ª—å `guest`, –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
1. **–í–ò–°–û–ö–ò–ô**: –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ 10 –∑–∞–ø–∏—Ç—ñ–≤ (2-3 –≥–æ–¥–∏–Ω–∏)
2. **–í–ò–°–û–ö–ò–ô**: –ï–∫—Ä–∞–Ω –º–∞–Ω—ñ–ø—É–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏–º–∏ (2-3 –≥–æ–¥–∏–Ω–∏)
3. **–°–ï–†–ï–î–ù–Ü–ô**: –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É (1-2 –≥–æ–¥–∏–Ω–∏)

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê 1: –í—ñ–¥—Å—É—Ç–Ω—ñ 10 –∑–∞–ø–∏—Ç—ñ–≤ –∑ —Ç–µ–º–∏ –∫—É—Ä—Å–æ–≤–æ—ó

### –°—Ç–∞—Ç—É—Å: ‚ùå –ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û

### –†—ñ—à–µ–Ω–Ω—è: –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥—É–ª—å queries_views.py

**–ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª `apps/api/views/queries_views.py`**

> **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –£—Å—ñ –∑–∞–ø–∏—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —ñ—Å–Ω—É—é—á–∏–π ORM –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é `__gte`, `__lte`, `__in`, `__icontains` —Ç–æ—â–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –≤—Å—ñ –ø–æ–ª—è –º–æ–¥–µ–ª–µ–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–º —É –∫–æ–¥—ñ.

```python
# apps/api/views/queries_views.py
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.response import Response
from rest_framework import status
from apps.crm.models import Supplier, Contract, Supply, Sale, Repair, Employee
from apps.main.models import Product, User
from datetime import datetime, timedelta
from collections import defaultdict


# ==================== –ó–ê–ü–ò–¢ 1 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query1_suppliers_with_products(request):
    """
    –ó–∞–ø–∏—Ç 1: –í–∏–≤–µ—Å—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤, –∞ —Ç–∞–∫–æ–∂ –ø—Ä–æ–¥—É–∫—Ü—ñ—é, —è–∫—É –≤–æ–Ω–∏ –ø–æ—Å—Ç–∞—á–∞—é—Ç—å
    """
    suppliers = Supplier.objects().all()
    result = []
    
    for supplier in suppliers:
        # –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –¥–æ–≥–æ–≤–æ—Ä–∏ –∑ —Ü–∏–º –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º
        contracts = Contract.objects().filter(supplier_id=supplier._id).all()
        products = []
        seen_products = set()
        
        for contract in contracts:
            if not contract.products:
                continue
            for product_item in contract.products:
                product_id = product_item.product_id
                if product_id in seen_products:
                    continue
                seen_products.add(product_id)
                
                product = Product.find_by_id(product_id)
                if product:
                    products.append({
                        'product_id': str(product._id),
                        'product_name': product.name,
                        'manufacturer': product.manufacturer,
                        'product_type': product.product_type,
                        'quantity': product_item.quantity,
                        'unit_price': product_item.unit_price
                    })
        
        result.append({
            'supplier': {
                'id': str(supplier._id),
                'name': supplier.name,
                'contact_person': supplier.contact_person,
                'email': supplier.email,
                'phone': supplier.phone,
                'address': supplier.address
            },
            'products': products,
            'total_products': len(products)
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query1_components_multiple_suppliers(request):
    """
    –ó–∞–ø–∏—Ç 1 (—á–∞—Å—Ç–∏–Ω–∞ 2): –ó–Ω–∞–π—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ, —è–∫—ñ –ø–æ—Å—Ç–∞—á–∞—é—Ç—å—Å—è –¥–≤–æ–º–∞ —ñ –±—ñ–ª—å—à–µ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏
    """
    # –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑ –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
    product_suppliers = defaultdict(set)  # product_id -> set of supplier_ids
    
    contracts = Contract.objects().all()
    for contract in contracts:
        if not contract.products:
            continue
        for product_item in contract.products:
            product_id = product_item.product_id
            product_suppliers[product_id].add(contract.supplier_id)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥—É–∫—Ç–∏, —è–∫—ñ –ø–æ—Å—Ç–∞—á–∞—é—Ç—å—Å—è 2+ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏
    result = []
    for product_id, supplier_ids in product_suppliers.items():
        if len(supplier_ids) >= 2:
            product = Product.find_by_id(product_id)
            if product and product.product_type in Product.COMPONENT_CHOICES:
                suppliers_info = []
                for supplier_id in supplier_ids:
                    supplier = Supplier.find_by_id(supplier_id)
                    if supplier:
                        suppliers_info.append({
                            'id': str(supplier._id),
                            'name': supplier.name,
                            'email': supplier.email
                        })
                
                result.append({
                    'product_id': str(product._id),
                    'product_name': product.name,
                    'manufacturer': product.manufacturer,
                    'product_type': product.product_type,
                    'suppliers_count': len(supplier_ids),
                    'suppliers': suppliers_info
                })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


# ==================== –ó–ê–ü–ò–¢ 2 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query2_customers_by_manufacturer(request):
    """
    –ó–∞–ø–∏—Ç 2: –í–∏–≤–µ—Å—Ç–∏ –ø–æ–≤–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤, —è–∫—ñ –ø—Ä–∏–¥–±–∞–ª–∏ –∫–æ–º–ø'—é—Ç–µ—Ä–Ω—É —Ç–µ—Ö–Ω—ñ–∫—É 
    (–∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ) –≤–∫–∞–∑–∞–Ω–æ—ó —Ñ—ñ—Ä–º–∏
    """
    manufacturer = request.GET.get('manufacturer', '').strip()
    
    if not manufacturer:
        return Response({
            'success': False,
            'error': '–ü–∞—Ä–∞–º–µ—Ç—Ä manufacturer –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø—Ä–æ–¥—É–∫—Ç–∏ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –≤–∏—Ä–æ–±–Ω–∏–∫–∞
    products = Product.objects().filter(manufacturer__icontains=manufacturer).all()
    product_ids = [str(p._id) for p in products]
    
    if not product_ids:
        return Response({
            'success': True,
            'data': [],
            'count': 0,
            'message': f'–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ –≤–∏—Ä–æ–±–Ω–∏–∫–∞ {manufacturer}'
        })
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø—Ä–æ–¥–∞–∂—ñ, —â–æ –º—ñ—Å—Ç—è—Ç—å —Ü—ñ –ø—Ä–æ–¥—É–∫—Ç–∏
    sales = Sale.objects().all()
    customer_ids = set()
    customer_sales = defaultdict(list)
    
    for sale in sales:
        if not sale.products:
            continue
        for product_item in sale.products:
            if str(product_item.product_id) in product_ids:
                customer_ids.add(sale.user_id)
                customer_sales[sale.user_id].append({
                    'sale_id': str(sale._id),
                    'sale_date': sale.sale_date.isoformat() if sale.sale_date else None,
                    'total_amount': sale.total_amount,
                    'product_name': next((p.name for p in products if str(p._id) == str(product_item.product_id)), 'Unknown')
                })
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç—ñ–≤
    result = []
    for user_id in customer_ids:
        user = User.find_by_id(user_id)
        if user:
            result.append({
                'customer': {
                    'id': str(user._id),
                    'username': user.username,
                    'email': user.email,
                    'role': user.role,
                    'created_at': user.created_at.isoformat() if user.created_at else None
                },
                'purchases': customer_sales[user_id],
                'total_purchases': len(customer_sales[user_id])
            })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result),
        'manufacturer': manufacturer
    })


# ==================== –ó–ê–ü–ò–¢ 3 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query3_warranty_repairs_returned(request):
    """
    –ó–∞–ø–∏—Ç 3 (—á–∞—Å—Ç–∏–Ω–∞ 1): –¢–æ–≤–∞—Ä–∏, —è–∫—ñ –±—É–ª–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—ñ –≤ —Ä–µ–º–æ–Ω—Ç –∑–∞ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é
    """
    repairs = Repair.objects().filter(
        repair_type='warranty',
        status='returned'
    ).all()
    
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: –°—Ç–∞—Ç—É—Å 'returned' —î –≤ STATUS_CHOICES –º–æ–¥–µ–ª—ñ Repair (—Ä—è–¥–æ–∫ 179)
    
    result = []
    for repair in repairs:
        product = Product.find_by_id(repair.product_id) if repair.product_id else None
        user = User.find_by_id(repair.user_id) if repair.user_id else None
        
        result.append({
            'repair_id': str(repair._id),
            'product': {
                'id': str(product._id) if product else None,
                'name': product.name if product else 'Unknown',
                'manufacturer': product.manufacturer if product else None
            } if product else None,
            'customer': {
                'id': str(user._id) if user else None,
                'username': user.username if user else 'Unknown',
                'email': user.email if user else None
            } if user else None,
            'description': repair.description,
            'start_date': repair.start_date.isoformat() if repair.start_date else None,
            'completion_date': repair.completion_date.isoformat() if repair.completion_date else None,
            'cost': repair.cost
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query3_warranty_repairs_completed(request):
    """
    –ó–∞–ø–∏—Ç 3 (—á–∞—Å—Ç–∏–Ω–∞ 2): –¢–æ–≤–∞—Ä–∏, —è–∫—ñ –±—É–ª–æ –≤—ñ–¥—Ä–µ–º–æ–Ω—Ç–æ–≤–∞–Ω–æ –∑–∞ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é
    """
    repairs = Repair.objects().filter(
        repair_type='warranty',
        status='completed'
    ).all()
    
    result = []
    for repair in repairs:
        product = Product.find_by_id(repair.product_id) if repair.product_id else None
        user = User.find_by_id(repair.user_id) if repair.user_id else None
        
        result.append({
            'repair_id': str(repair._id),
            'product': {
                'id': str(product._id) if product else None,
                'name': product.name if product else 'Unknown',
                'manufacturer': product.manufacturer if product else None
            } if product else None,
            'customer': {
                'id': str(user._id) if user else None,
                'username': user.username if user else 'Unknown',
                'email': user.email if user else None
            } if user else None,
            'description': repair.description,
            'start_date': repair.start_date.isoformat() if repair.start_date else None,
            'completion_date': repair.completion_date.isoformat() if repair.completion_date else None,
            'cost': repair.cost
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query3_warranty_repairs_in_progress(request):
    """
    –ó–∞–ø–∏—Ç 3 (—á–∞—Å—Ç–∏–Ω–∞ 3): –í—Å—ñ —Ä–µ–º–æ–Ω—Ç–Ω—ñ —Ä–æ–±–æ—Ç–∏, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –∑–∞ –≥–∞—Ä–∞–Ω—Ç—ñ—î—é
    """
    repairs = Repair.objects().filter(
        repair_type='warranty',
        status__in=['received', 'diagnosed', 'repairing']
    ).all()
    
    result = []
    for repair in repairs:
        product = Product.find_by_id(repair.product_id) if repair.product_id else None
        user = User.find_by_id(repair.user_id) if repair.user_id else None
        employee = Employee.find_by_id(repair.employee_id) if repair.employee_id else None
        
        result.append({
            'repair_id': str(repair._id),
            'status': repair.status,
            'product': {
                'id': str(product._id) if product else None,
                'name': product.name if product else 'Unknown',
                'manufacturer': product.manufacturer if product else None
            } if product else None,
            'customer': {
                'id': str(user._id) if user else None,
                'username': user.username if user else 'Unknown',
                'email': user.email if user else None
            } if user else None,
            'employee': {
                'id': str(employee._id) if employee else None,
                'full_name': employee.full_name if employee else 'Unknown',
                'position': employee.position if employee else None
            } if employee else None,
            'description': repair.description,
            'start_date': repair.start_date.isoformat() if repair.start_date else None,
            'estimated_completion': repair.estimated_completion.isoformat() if repair.estimated_completion else None
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


# ==================== –ó–ê–ü–ò–¢ 4 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query4_max_revenue_by_month(request):
    """
    –ó–∞–ø–∏—Ç 4 (—á–∞—Å—Ç–∏–Ω–∞ 1): –í–∏–∑–Ω–∞—á–∏—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É —Å—É–º—É –≤–∏—Ç–æ—Ä–≥—É –∑–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –º—ñ—Å—è—Ü—å
    """
    month_str = request.GET.get('month', '').strip()  # –§–æ—Ä–º–∞—Ç: "2025-01"
    
    if not month_str:
        # –Ø–∫—â–æ –Ω–µ –≤–∫–∞–∑–∞–Ω–æ, –±–µ—Ä–µ–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å
        now = datetime.now()
        month_str = now.strftime('%Y-%m')
    
    try:
        year, month = map(int, month_str.split('-'))
        month_start = datetime(year, month, 1)
        if month == 12:
            month_end = datetime(year + 1, 1, 1)
        else:
            month_end = datetime(year, month + 1, 1)
    except ValueError:
        return Response({
            'success': False,
            'error': '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –º—ñ—Å—è—Ü—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: YYYY-MM'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø—Ä–æ–¥–∞–∂—ñ –∑–∞ –º—ñ—Å—è—Ü—å
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: ORM –ø—ñ–¥—Ç—Ä–∏–º—É—î __gte —Ç–∞ __lt –¥–ª—è DateTimeField
    sales = Sale.objects().filter(
        sale_date__gte=month_start,
        sale_date__lt=month_end
    ).all()
    
    max_revenue = 0
    max_sale = None
    
    for sale in sales:
        if sale.total_amount and sale.total_amount > max_revenue:
            max_revenue = sale.total_amount
            max_sale = sale
    
    result = {
        'month': month_str,
        'max_revenue': max_revenue,
        'sale': {
            'id': str(max_sale._id),
            'sale_date': max_sale.sale_date.isoformat() if max_sale and max_sale.sale_date else None,
            'total_amount': max_sale.total_amount if max_sale else 0
        } if max_sale else None
    }
    
    return Response({
        'success': True,
        'data': result
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query4_revenue_by_product_type_last_week(request):
    """
    –ó–∞–ø–∏—Ç 4 (—á–∞—Å—Ç–∏–Ω–∞ 2): –í–∏—Ç–æ—Ä–≥ –∑–∞ —Ä—ñ–∑–Ω–∏–º–∏ –≤–∏–¥–∞–º–∏ —Ç–æ–≤–∞—Ä—É –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å
    """
    now = datetime.now()
    week_ago = now - timedelta(days=7)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø—Ä–æ–¥–∞–∂—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ç–∏–∂–¥–µ–Ω—å
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: ORM –ø—ñ–¥—Ç—Ä–∏–º—É—î __gte —Ç–∞ __lte –¥–ª—è DateTimeField
    sales = Sale.objects().filter(
        sale_date__gte=week_ago,
        sale_date__lte=now
    ).all()
    
    revenue_by_type = defaultdict(float)
    
    for sale in sales:
        if not sale.products:
            continue
        for product_item in sale.products:
            product = Product.find_by_id(product_item.product_id)
            if product:
                product_type = product.product_type
                revenue = (product_item.unit_price or 0) * (product_item.quantity or 0)
                revenue_by_type[product_type] += revenue
    
    result = [
        {
            'product_type': product_type,
            'revenue': revenue,
            'revenue_formatted': f'{revenue:.2f}'
        }
        for product_type, revenue in sorted(revenue_by_type.items(), key=lambda x: x[1], reverse=True)
    ]
    
    return Response({
        'success': True,
        'data': result,
        'period': {
            'start': week_ago.isoformat(),
            'end': now.isoformat()
        },
        'total_revenue': sum(revenue_by_type.values())
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query4_sales_by_employee(request):
    """
    –ó–∞–ø–∏—Ç 4 (—á–∞—Å—Ç–∏–Ω–∞ 3): –°–∫—ñ–ª—å–∫–∏ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó –±—É–ª–æ –ø—Ä–æ–¥–∞–Ω–æ –∫–æ–∂–Ω–∏–º –ø—Ä–æ–¥–∞–≤—Ü–µ–º
    """
    sales = Sale.objects().all()
    
    employee_sales = defaultdict(lambda: {
        'total_products': 0,
        'total_amount': 0,
        'sales_count': 0
    })
    
    for sale in sales:
        if not sale.employee_id:
            continue
        
        employee = Employee.find_by_id(sale.employee_id)
        if not employee:
            continue
        
        employee_id = str(employee._id)
        employee_sales[employee_id]['sales_count'] += 1
        employee_sales[employee_id]['total_amount'] += sale.total_amount or 0
        
        if sale.products:
            for product_item in sale.products:
                employee_sales[employee_id]['total_products'] += product_item.quantity or 0
    
    result = []
    for employee_id, stats in employee_sales.items():
        employee = Employee.find_by_id(employee_id)
        if employee:
            result.append({
                'employee': {
                    'id': employee_id,
                    'full_name': employee.full_name,
                    'position': employee.position,
                    'email': employee.email
                },
                'statistics': {
                    'total_products_sold': stats['total_products'],
                    'total_revenue': stats['total_amount'],
                    'sales_count': stats['sales_count']
                }
            })
    
    # –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø—Ä–æ–¥–∞–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
    result.sort(key=lambda x: x['statistics']['total_products_sold'], reverse=True)
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


# ==================== –ó–ê–ü–ò–¢ 5 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query5_components_by_price(request):
    """
    –ó–∞–ø–∏—Ç 5: –ü–µ—Ä–µ–ª—ñ–∫ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á–∏—Ö, –≤–∞—Ä—Ç—ñ—Å—Ç—å —è–∫–∏—Ö –Ω–µ –ø–µ—Ä–µ–≤–∏—â—É—î –∑–∞–¥–∞–Ω–æ—ó —Å—É–º–∏
    """
    try:
        max_price = float(request.GET.get('max_price', 0))
    except ValueError:
        return Response({
            'success': False,
            'error': '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç max_price. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —á–∏—Å–ª–æ.'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    if max_price <= 0:
        return Response({
            'success': False,
            'error': 'max_price –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ (–Ω–µ –ø–µ—Ä–∏—Ñ–µ—Ä—ñ—é, –Ω–µ –Ω–æ—É—Ç–±—É–∫–∏)
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: COMPONENT_CHOICES - —Ü–µ —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂—ñ–≤, –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –ø–µ—Ä—à—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
    component_types = [choice[0] for choice in Product.COMPONENT_CHOICES]
    components = Product.objects().filter(
        product_type__in=component_types
    ).filter(
        price__lte=max_price
    ).all()
    
    result = []
    for component in components:
        result.append({
            'product_id': str(component._id),
            'name': component.name,
            'manufacturer': component.manufacturer,
            'product_type': component.product_type,
            'price': component.price,
            'quantity_in_stock': component.quantity_in_stock,
            'warranty_months': component.warranty_months
        })
    
    # –°–æ—Ä—Ç—É—î–º–æ –∑–∞ —Ü—ñ–Ω–æ—é
    result.sort(key=lambda x: x['price'])
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result),
        'max_price': max_price
    })


# ==================== –ó–ê–ü–ò–¢ 6 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query6_suppliers_by_repair_frequency(request):
    """
    –ó–∞–ø–∏—Ç 6: –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏, —Ç–æ–≤–∞—Ä–∏ —è–∫–∏—Ö –Ω–∞–π—á–∞—Å—Ç—ñ—à–µ –ø–æ—Ç—Ä–∞–ø–ª—è—é—Ç—å –≤ —Ä–µ–º–æ–Ω—Ç
    """
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ —Ä–µ–º–æ–Ω—Ç–∏
    repairs = Repair.objects().all()
    
    # –ó–±–∏—Ä–∞—î–º–æ product_id -> –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç—ñ–≤
    product_repair_count = defaultdict(int)
    
    for repair in repairs:
        if repair.product_id:
            product_repair_count[str(repair.product_id)] += 1
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤ —á–µ—Ä–µ–∑ –¥–æ–≥–æ–≤–æ—Ä–∏
    supplier_repair_count = defaultdict(int)
    supplier_products = defaultdict(set)
    
    contracts = Contract.objects().all()
    for contract in contracts:
        if not contract.products:
            continue
        supplier_id = str(contract.supplier_id)
        for product_item in contract.products:
            product_id = str(product_item.product_id)
            supplier_products[supplier_id].add(product_id)
            if product_id in product_repair_count:
                supplier_repair_count[supplier_id] += product_repair_count[product_id]
    
    # –§–æ—Ä–º—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result = []
    for supplier_id, repair_count in sorted(supplier_repair_count.items(), key=lambda x: x[1], reverse=True):
        supplier = Supplier.find_by_id(supplier_id)
        if supplier:
            result.append({
                'supplier': {
                    'id': supplier_id,
                    'name': supplier.name,
                    'contact_person': supplier.contact_person,
                    'email': supplier.email,
                    'phone': supplier.phone
                },
                'repairs_count': repair_count,
                'products_count': len(supplier_products[supplier_id])
            })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


# ==================== –ó–ê–ü–ò–¢ 7 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query7_custom_build_components(request):
    """
    –ó–∞–ø–∏—Ç 7: –ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –∫–∞—Å—Ç–æ–º–Ω–æ—ó –∑–±—ñ—Ä–∫–∏ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞
    """
    user_id = request.GET.get('user_id')
    sale_id = request.GET.get('sale_id')
    
    if not user_id and not sale_id:
        return Response({
            'success': False,
            'error': '–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä user_id –∞–±–æ sale_id'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø—Ä–æ–¥–∞–∂
    sale = None
    if sale_id:
        sale = Sale.find_by_id(sale_id)
    elif user_id:
        # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø—Ä–æ–¥–∞–∂ –∑ –∫–∞—Å—Ç–æ–º–Ω–æ—é –∑–±—ñ—Ä–∫–æ—é –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        sales = Sale.objects().filter(user_id=user_id).order_by('-sale_date').all()
        for s in sales:
            if s.custom_build_service and hasattr(s.custom_build_service, 'purchased') and s.custom_build_service.purchased:
                sale = s
                break
    
    if not sale or not sale.custom_build_service:
        return Response({
            'success': False,
            'error': '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥–∞–∂ –∑ –∫–∞—Å—Ç–æ–º–Ω–æ—é –∑–±—ñ—Ä–∫–æ—é'
        }, status=status.HTTP_404_NOT_FOUND)
    
    # custom_build_service —Ü–µ CustomBuildConfig, —è–∫–∏–π –º–∞—î –ø–æ–ª–µ data —Ç–∏–ø—É CustomBuild
    custom_build_config = sale.custom_build_service
    if not hasattr(custom_build_config, 'purchased') or not custom_build_config.purchased:
        return Response({
            'success': False,
            'error': '–ö–∞—Å—Ç–æ–º–Ω–∞ –∑–±—ñ—Ä–∫–∞ –Ω–µ –±—É–ª–∞ –ø—Ä–∏–¥–±–∞–Ω–∞'
        }, status=status.HTTP_404_NOT_FOUND)
    
    custom_build = custom_build_config.data if hasattr(custom_build_config, 'data') else None
    if not custom_build or not custom_build.products:
        return Response({
            'success': False,
            'error': '–ö–∞—Å—Ç–æ–º–Ω–∞ –∑–±—ñ—Ä–∫–∞ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ñ–≤'
        }, status=status.HTTP_404_NOT_FOUND)
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ
    components = []
    for product_item in custom_build.products:
        product = Product.find_by_id(product_item.product_id)
        if product:
            components.append({
                'product_id': str(product._id),
                'name': product.name,
                'manufacturer': product.manufacturer,
                'product_type': product.product_type,
                'quantity': product_item.quantity,
                'unit_price': product_item.unit_price,
                'total_price': (product_item.quantity or 0) * (product_item.unit_price or 0)
            })
    
    user = User.find_by_id(sale.user_id) if sale.user_id else None
    
    return Response({
        'success': True,
        'data': {
            'sale': {
                'id': str(sale._id),
                'sale_date': sale.sale_date.isoformat() if sale.sale_date else None,
                'total_amount': sale.total_amount
            },
            'customer': {
                'id': str(user._id) if user else None,
                'username': user.username if user else 'Unknown',
                'email': user.email if user else None
            } if user else None,
            'custom_build': {
                'name': custom_build.name,
                'status': custom_build.status,
                'total_cost': custom_build.total_cost,
                'assembly_date': custom_build.assembly_date.isoformat() if custom_build.assembly_date else None
            },
            'components': components,
            'total_components': len(components)
        }
    })


# ==================== –ó–ê–ü–ò–¢ 8 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query8_product_supplies_by_period(request):
    """
    –ó–∞–ø–∏—Ç 8: –°–∫—ñ–ª—å–∫–∏ –≤–∫–∞–∑–∞–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É –±—É–ª–æ –æ–¥–µ—Ä–∂–∞–Ω–æ –≤—ñ–¥ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤ –∑–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
    """
    product_id = request.GET.get('product_id')
    start_date_str = request.GET.get('start_date')
    end_date_str = request.GET.get('end_date')
    
    if not product_id:
        return Response({
            'success': False,
            'error': '–ü–∞—Ä–∞–º–µ—Ç—Ä product_id –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    product = Product.find_by_id(product_id)
    if not product:
        return Response({
            'success': False,
            'error': '–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'
        }, status=status.HTTP_404_NOT_FOUND)
    
    # –ü–∞—Ä—Å–∏–º–æ –¥–∞—Ç–∏
    try:
        start_date = datetime.fromisoformat(start_date_str) if start_date_str else datetime(2000, 1, 1)
        end_date = datetime.fromisoformat(end_date_str) if end_date_str else datetime.now()
    except ValueError:
        return Response({
            'success': False,
            'error': '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ISO —Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DD'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –∑–∞ –ø–µ—Ä—ñ–æ–¥
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: ORM –ø—ñ–¥—Ç—Ä–∏–º—É—î __gte —Ç–∞ __lte –¥–ª—è DateTimeField
    supplies = Supply.objects().filter(
        delivery_date__gte=start_date,
        delivery_date__lte=end_date
    ).all()
    
    total_quantity = 0
    supplies_info = []
    
    for supply in supplies:
        if not supply.products:
            continue
        for product_item in supply.products:
            if str(product_item.product_id) == str(product_id):
                quantity = product_item.quantity or 0
                total_quantity += quantity
                
                supplier = Supplier.find_by_id(supply.supplier_id) if supply.supplier_id else None
                contract = Contract.find_by_id(supply.contract_id) if supply.contract_id else None
                
                supplies_info.append({
                    'supply_id': str(supply._id),
                    'supplier': {
                        'id': str(supplier._id) if supplier else None,
                        'name': supplier.name if supplier else 'Unknown'
                    } if supplier else None,
                    'contract': {
                        'id': str(contract._id) if contract else None,
                        'number': contract.number if contract else None
                    } if contract else None,
                    'quantity': quantity,
                    'unit_price': product_item.unit_price,
                    'delivery_date': supply.delivery_date.isoformat() if supply.delivery_date else None,
                    'status': supply.status
                })
    
    return Response({
        'success': True,
        'data': {
            'product': {
                'id': str(product._id),
                'name': product.name,
                'manufacturer': product.manufacturer
            },
            'period': {
                'start': start_date.isoformat(),
                'end': end_date.isoformat()
            },
            'total_quantity_received': total_quantity,
            'supplies': supplies_info,
            'supplies_count': len(supplies_info)
        }
    })


# ==================== –ó–ê–ü–ò–¢ 9 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query9_contracts_by_period(request):
    """
    –ó–∞–ø–∏—Ç 9 (—á–∞—Å—Ç–∏–Ω–∞ 1): –î–æ–≥–æ–≤–æ—Ä–∏, —è–∫—ñ –±—É–ª–∏ —É–∫–ª–∞–¥–µ–Ω—ñ –∑–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
    """
    start_date_str = request.GET.get('start_date')
    end_date_str = request.GET.get('end_date')
    
    try:
        start_date = datetime.fromisoformat(start_date_str) if start_date_str else datetime(2000, 1, 1)
        end_date = datetime.fromisoformat(end_date_str) if end_date_str else datetime.now()
    except ValueError:
        return Response({
            'success': False,
            'error': '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ISO —Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DD'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    contracts = Contract.objects().filter(
        signing_date__gte=start_date,
        signing_date__lte=end_date
    ).order_by('-signing_date').all()
    
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: order_by('-signing_date') –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è ORM
    
    result = []
    for contract in contracts:
        supplier = Supplier.find_by_id(contract.supplier_id) if contract.supplier_id else None
        
        result.append({
            'contract': {
                'id': str(contract._id),
                'number': contract.number,
                'total_amount': contract.total_amount,
                'signing_date': contract.signing_date.isoformat() if contract.signing_date else None,
                'delivery_date': contract.delivery_date.isoformat() if contract.delivery_date else None,
                'status': contract.status,
                'notes': contract.notes
            },
            'supplier': {
                'id': str(supplier._id) if supplier else None,
                'name': supplier.name if supplier else 'Unknown',
                'contact_person': supplier.contact_person if supplier else None,
                'email': supplier.email if supplier else None
            } if supplier else None,
            'products_count': len(contract.products) if contract.products else 0
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result),
        'period': {
            'start': start_date.isoformat(),
            'end': end_date.isoformat()
        }
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query9_contracts_count_by_supplier(request):
    """
    –ó–∞–ø–∏—Ç 9 (—á–∞—Å—Ç–∏–Ω–∞ 2): –ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ñ–≤, —É–∫–ª–∞–¥–µ–Ω–∏—Ö –∑ –∫–æ–∂–Ω–∏–º –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–æ–º
    """
    contracts = Contract.objects().all()
    
    supplier_contracts = defaultdict(lambda: {
        'count': 0,
        'total_amount': 0,
        'contracts': []
    })
    
    for contract in contracts:
        supplier_id = str(contract.supplier_id) if contract.supplier_id else None
        if supplier_id:
            supplier_contracts[supplier_id]['count'] += 1
            supplier_contracts[supplier_id]['total_amount'] += contract.total_amount or 0
            supplier_contracts[supplier_id]['contracts'].append({
                'id': str(contract._id),
                'number': contract.number,
                'signing_date': contract.signing_date.isoformat() if contract.signing_date else None,
                'status': contract.status
            })
    
    result = []
    for supplier_id, stats in supplier_contracts.items():
        supplier = Supplier.find_by_id(supplier_id)
        if supplier:
            result.append({
                'supplier': {
                    'id': supplier_id,
                    'name': supplier.name,
                    'contact_person': supplier.contact_person,
                    'email': supplier.email,
                    'phone': supplier.phone
                },
                'contracts_count': stats['count'],
                'total_amount': stats['total_amount'],
                'contracts': stats['contracts']
            })
    
    # –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –¥–æ–≥–æ–≤–æ—Ä—ñ–≤
    result.sort(key=lambda x: x['contracts_count'], reverse=True)
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


# ==================== –ó–ê–ü–ò–¢ 10 ====================

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def query10_supplier_by_contract_number(request):
    """
    –ó–∞–ø–∏—Ç 10: –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ —Ç–æ–≤–∞—Ä—É –∑–∞ –Ω–æ–º–µ—Ä–æ–º –¥–æ–≥–æ–≤–æ—Ä—É
    """
    contract_number = request.GET.get('contract_number', '').strip()
    
    if not contract_number:
        return Response({
            'success': False,
            'error': '–ü–∞—Ä–∞–º–µ—Ç—Ä contract_number –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    contract = Contract.objects().filter(number=contract_number).first()
    
    if not contract:
        return Response({
            'success': False,
            'error': f'–î–æ–≥–æ–≤—ñ—Ä –∑ –Ω–æ–º–µ—Ä–æ–º {contract_number} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'
        }, status=status.HTTP_404_NOT_FOUND)
    
    supplier = Supplier.find_by_id(contract.supplier_id) if contract.supplier_id else None
    
    if not supplier:
        return Response({
            'success': False,
            'error': '–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'
        }, status=status.HTTP_404_NOT_FOUND)
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ç–∏ –≤ –¥–æ–≥–æ–≤–æ—Ä—ñ
    products_info = []
    if contract.products:
        for product_item in contract.products:
            product = Product.find_by_id(product_item.product_id)
            if product:
                products_info.append({
                    'product_id': str(product._id),
                    'name': product.name,
                    'manufacturer': product.manufacturer,
                    'quantity': product_item.quantity,
                    'unit_price': product_item.unit_price
                })
    
    return Response({
        'success': True,
        'data': {
            'contract': {
                'id': str(contract._id),
                'number': contract.number,
                'total_amount': contract.total_amount,
                'signing_date': contract.signing_date.isoformat() if contract.signing_date else None,
                'delivery_date': contract.delivery_date.isoformat() if contract.delivery_date else None,
                'status': contract.status
            },
            'supplier': {
                'id': str(supplier._id),
                'name': supplier.name,
                'contact_person': supplier.contact_person,
                'email': supplier.email,
                'phone': supplier.phone,
                'address': supplier.address,
                'description': supplier.description
            },
            'products': products_info,
            'products_count': len(products_info)
        }
    })
```

**–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª `apps/api/urls/queries_urls.py`**

```python
# apps/api/urls/queries_urls.py
from django.urls import path
from apps.api.views.queries_views import (
    query1_suppliers_with_products,
    query1_components_multiple_suppliers,
    query2_customers_by_manufacturer,
    query3_warranty_repairs_returned,
    query3_warranty_repairs_completed,
    query3_warranty_repairs_in_progress,
    query4_max_revenue_by_month,
    query4_revenue_by_product_type_last_week,
    query4_sales_by_employee,
    query5_components_by_price,
    query6_suppliers_by_repair_frequency,
    query7_custom_build_components,
    query8_product_supplies_by_period,
    query9_contracts_by_period,
    query9_contracts_count_by_supplier,
    query10_supplier_by_contract_number,
)

app_name = 'queries'

urlpatterns = [
    # –ó–∞–ø–∏—Ç 1
    path('suppliers-with-products/', query1_suppliers_with_products, name='query1_suppliers'),
    path('components-multiple-suppliers/', query1_components_multiple_suppliers, name='query1_components'),
    
    # –ó–∞–ø–∏—Ç 2
    path('customers-by-manufacturer/', query2_customers_by_manufacturer, name='query2'),
    
    # –ó–∞–ø–∏—Ç 3
    path('warranty-repairs-returned/', query3_warranty_repairs_returned, name='query3_returned'),
    path('warranty-repairs-completed/', query3_warranty_repairs_completed, name='query3_completed'),
    path('warranty-repairs-in-progress/', query3_warranty_repairs_in_progress, name='query3_in_progress'),
    
    # –ó–∞–ø–∏—Ç 4
    path('max-revenue-by-month/', query4_max_revenue_by_month, name='query4_max_revenue'),
    path('revenue-by-product-type-last-week/', query4_revenue_by_product_type_last_week, name='query4_revenue_week'),
    path('sales-by-employee/', query4_sales_by_employee, name='query4_sales_employee'),
    
    # –ó–∞–ø–∏—Ç 5
    path('components-by-price/', query5_components_by_price, name='query5'),
    
    # –ó–∞–ø–∏—Ç 6
    path('suppliers-by-repair-frequency/', query6_suppliers_by_repair_frequency, name='query6'),
    
    # –ó–∞–ø–∏—Ç 7
    path('custom-build-components/', query7_custom_build_components, name='query7'),
    
    # –ó–∞–ø–∏—Ç 8
    path('product-supplies-by-period/', query8_product_supplies_by_period, name='query8'),
    
    # –ó–∞–ø–∏—Ç 9
    path('contracts-by-period/', query9_contracts_by_period, name='query9_contracts'),
    path('contracts-count-by-supplier/', query9_contracts_count_by_supplier, name='query9_count'),
    
    # –ó–∞–ø–∏—Ç 10
    path('supplier-by-contract-number/', query10_supplier_by_contract_number, name='query10'),
]
```

**–ö—Ä–æ–∫ 3: –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ URLs –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥—É**

–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –≤ `apps/api/urls/__init__.py`:
```python
path('queries/', include('apps.api.urls.queries_urls')),
```

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê 2: –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –µ–∫—Ä–∞–Ω—É –º–∞–Ω—ñ–ø—É–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏–º–∏ —á–µ—Ä–µ–∑ SQL/–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó

### –°—Ç–∞—Ç—É—Å: ‚ùå –ù–ï –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û (–ö–†–ò–¢–ò–ß–ù–û –∑–≥—ñ–¥–Ω–æ –∑ –º–µ—Ç–æ–¥–∏—á–∫–æ—é)

### –†—ñ—à–µ–Ω–Ω—è: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è MongoDB aggregation queries

**–ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—å –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑–∞–ø–∏—Ç—ñ–≤**

```python
# –î–æ–¥–∞—Ç–∏ –≤ apps/main/models.py (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ) –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ apps/api/models.py

class SavedQuery(orm.Model):
    """–ú–æ–¥–µ–ª—å –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∑–∞–ø–∏—Ç—ñ–≤"""
    _collection_name = 'saved_queries'
    
    user_id = orm.ReferenceField(User, required=True)
    query_name = orm.StringField(required=True, max_length=200)
    query_type = orm.StringField(required=True)  # 'builtin' –∞–±–æ 'custom'
    query_params = orm.DictField()  # –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞–ø–∏—Ç—É
    results = orm.ListField()  # –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞–ø–∏—Ç—É
    created_at = orm.DateTimeField(default=datetime.now)
    
    def to_dict(self, serialize=True):
        data = super().to_dict(serialize)
        return data
```

**–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ views –¥–ª—è –º–∞–Ω—ñ–ø—É–ª—é–≤–∞–Ω–Ω—è –¥–∞–Ω–∏–º–∏**

```python
# apps/api/views/query_executor_views.py
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
from apps.api.models import SavedQuery  # –Ø–∫—â–æ —Å—Ç–≤–æ—Ä–∏–ª–∏
from apps.main.models import User
from datetime import datetime
import json

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–ø–∏—Ç—ñ–≤
from apps.api.views.queries_views import (
    query1_suppliers_with_products,
    query1_components_multiple_suppliers,
    query2_customers_by_manufacturer,
    # ... –≤—Å—ñ —ñ–Ω—à—ñ
)

# –°–ª–æ–≤–Ω–∏–∫ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
BUILTIN_QUERIES = {
    'suppliers_with_products': query1_suppliers_with_products,
    'components_multiple_suppliers': query1_components_multiple_suppliers,
    'customers_by_manufacturer': query2_customers_by_manufacturer,
    'warranty_repairs_returned': query3_warranty_repairs_returned,
    'warranty_repairs_completed': query3_warranty_repairs_completed,
    'warranty_repairs_in_progress': query3_warranty_repairs_in_progress,
    'max_revenue_by_month': query4_max_revenue_by_month,
    'revenue_by_product_type_last_week': query4_revenue_by_product_type_last_week,
    'sales_by_employee': query4_sales_by_employee,
    'components_by_price': query5_components_by_price,
    'suppliers_by_repair_frequency': query6_suppliers_by_repair_frequency,
    'custom_build_components': query7_custom_build_components,
    'product_supplies_by_period': query8_product_supplies_by_period,
    'contracts_by_period': query9_contracts_by_period,
    'contracts_count_by_supplier': query9_contracts_count_by_supplier,
    'supplier_by_contract_number': query10_supplier_by_contract_number,
}


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def list_builtin_queries(request):
    """
    –°–ø–∏—Å–æ–∫ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ (–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö)
    """
    queries_list = [
        {
            'id': key,
            'name': key.replace('_', ' ').title(),
            'type': 'builtin'
        }
        for key in BUILTIN_QUERIES.keys()
    ]
    
    return Response({
        'success': True,
        'data': queries_list,
        'count': len(queries_list)
    })


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def execute_builtin_query(request):
    """
    –í–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É (–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö)
    """
    query_id = request.data.get('query_id')
    params = request.data.get('params', {})
    
    if not query_id or query_id not in BUILTIN_QUERIES:
        return Response({
            'success': False,
            'error': '–ù–µ–≤—ñ—Ä–Ω–∏–π ID –∑–∞–ø–∏—Ç—É'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–µ–π–∫–æ–≤–∏–π request –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    class FakeRequest:
        def __init__(self, user, params):
            self.user = user
            self.GET = type('GET', (), params)()
            self.data = params
    
    fake_request = FakeRequest(request.user, params)
    
    try:
        query_func = BUILTIN_QUERIES[query_id]
        response = query_func(fake_request)
        
        # –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ö–æ—á–µ –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        save_result = request.data.get('save_result', False)
        if save_result and request.user.role in ['user', 'operator', 'admin']:
            saved_query = SavedQuery.create(
                user_id=request.user.id,
                query_name=query_id,
                query_type='builtin',
                query_params=params,
                results=response.data if hasattr(response, 'data') else {}
            )
            return Response({
                'success': True,
                'data': response.data if hasattr(response, 'data') else {},
                'saved_query_id': str(saved_query._id)
            })
        
        return response
        
    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def execute_custom_aggregation(request):
    """
    –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ MongoDB aggregation –∑–∞–ø–∏—Ç—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è operator —Ç–∞ admin)
    """
    if request.user.role not in ['operator', 'admin']:
        return Response({
            'success': False,
            'error': '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∞–±–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞'
        }, status=status.HTTP_403_FORBIDDEN)
    
    pipeline = request.data.get('pipeline')
    collection = request.data.get('collection')
    
    if not pipeline or not isinstance(pipeline, list):
        return Response({
            'success': False,
            'error': '–ü–∞—Ä–∞–º–µ—Ç—Ä pipeline –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Å–ø–∏—Å–∫–æ–º (MongoDB aggregation pipeline)'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    if not collection:
        return Response({
            'success': False,
            'error': '–ü–∞—Ä–∞–º–µ—Ç—Ä collection –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ë–µ–∑–ø–µ–∫–∞: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –∫–æ–ª–µ–∫—Ü—ñ–π
    # –ü—Ä–∏–º—ñ—Ç–∫–∞: –ù–∞–∑–≤–∏ –∫–æ–ª–µ–∫—Ü—ñ–π –º–∞—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ _collection_name –≤ –º–æ–¥–µ–ª—è—Ö
    ALLOWED_COLLECTIONS = [
        'suppliers', 'contracts', 'supplies', 'sales', 'repairs', 
        'employees', 'products', 'users', 'product_categories', 'deliveries'
    ]
    
    if collection not in ALLOWED_COLLECTIONS:
        return Response({
            'success': False,
            'error': f'–ö–æ–ª–µ–∫—Ü—ñ—è {collection} –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∞'
        }, status=status.HTTP_403_FORBIDDEN)
    
    try:
        from core.mongo_connection import get_db
        db = get_db()
        coll = db[collection]
        
        # –í–∏–∫–æ–Ω—É—î–º–æ aggregation
        results = list(coll.aggregate(pipeline))
        
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        save_result = request.data.get('save_result', False)
        if save_result:
            saved_query = SavedQuery.create(
                user_id=request.user.id,
                query_name=request.data.get('query_name', 'Custom Query'),
                query_type='custom',
                query_params={'collection': collection, 'pipeline': pipeline},
                results=results
            )
            return Response({
                'success': True,
                'data': results,
                'count': len(results),
                'saved_query_id': str(saved_query._id)
            })
        
        return Response({
            'success': True,
            'data': results,
            'count': len(results)
        })
        
    except Exception as e:
        return Response({
            'success': False,
            'error': f'–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É: {str(e)}'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def list_saved_queries(request):
    """
    –°–ø–∏—Å–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    saved_queries = SavedQuery.objects().filter(user_id=request.user.id).order_by('-created_at').all()
    
    result = []
    for sq in saved_queries:
        result.append({
            'id': str(sq._id),
            'query_name': sq.query_name,
            'query_type': sq.query_type,
            'created_at': sq.created_at.isoformat() if sq.created_at else None,
            'results_count': len(sq.results) if sq.results else 0
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_saved_query(request, query_id):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –∑–∞–ø–∏—Ç
    """
    saved_query = SavedQuery.find_by_id(query_id)
    
    if not saved_query:
        return Response({
            'success': False,
            'error': '–ó–∞–ø–∏—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'
        }, status=status.HTTP_404_NOT_FOUND)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É
    if str(saved_query.user_id) != request.user.id and request.user.role != 'admin':
        return Response({
            'success': False,
            'error': '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ'
        }, status=status.HTTP_403_FORBIDDEN)
    
    return Response({
        'success': True,
        'data': saved_query.to_dict()
    })
```

**–ö—Ä–æ–∫ 3: –î–æ–¥–∞—Ç–∏ URLs –¥–ª—è query executor**

```python
# apps/api/urls/query_executor_urls.py
from django.urls import path
from apps.api.views.query_executor_views import (
    list_builtin_queries,
    execute_builtin_query,
    execute_custom_aggregation,
    list_saved_queries,
    get_saved_query,
)

app_name = 'query_executor'

urlpatterns = [
    path('builtin/list/', list_builtin_queries, name='list_builtin'),
    path('builtin/execute/', execute_builtin_query, name='execute_builtin'),
    path('custom/execute/', execute_custom_aggregation, name='execute_custom'),
    path('saved/list/', list_saved_queries, name='list_saved'),
    path('saved/<str:query_id>/', get_saved_query, name='get_saved'),
]
```

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É

### –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è –ß–ê–°–¢–ö–û–í–û –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û

### –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è:
- ‚úÖ –†–æ–ª—ñ: `user`, `operator`, `admin`
- ‚ùå –í—ñ–¥—Å—É—Ç–Ω—è —Ä–æ–ª—å `guest`
- ‚ùå –í—ñ–¥—Å—É—Ç–Ω—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
- ‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∞–≤ –∑–≥—ñ–¥–Ω–æ –∑ –º–µ—Ç–æ–¥–∏—á–∫–æ—é

### –†—ñ—à–µ–Ω–Ω—è: –ü–æ–∫—Ä–∞—â–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É

**–ö—Ä–æ–∫ 1: –î–æ–¥–∞—Ç–∏ —Ä–æ–ª—å `guest` –¥–æ User –º–æ–¥–µ–ª—ñ**

```python
# apps/main/models.py - –æ–Ω–æ–≤–∏—Ç–∏ ROLE_CHOICES (—Ä—è–¥–æ–∫ 13-17)

class User(orm.Model):
    """–ú–æ–¥–µ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    _collection_name = "users"
    
    ROLE_CHOICES = [
        ("guest", "–ì—ñ—Å—Ç—å"),  # –ù–û–í–ï - –¥–æ–¥–∞—Ç–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ —Å–ø–∏—Å–∫—É
        ("user", "User"),    # –ó–∞–ª–∏—à–∏—Ç–∏ —è–∫ —î
        ("operator", "Operator"),
        ("admin", "Admin"),
    ]
    
    # ... —Ä–µ—à—Ç–∞ –∫–æ–¥—É –±–µ–∑ –∑–º—ñ–Ω
```

**–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é**

```python
# –î–æ–¥–∞—Ç–∏ –≤ apps/main/models.py (–≤ –∫—ñ–Ω—Ü—ñ —Ñ–∞–π–ª—É, –ø—ñ—Å–ª—è Delivery)

class RegistrationRequest(orm.Model):
    """–ú–æ–¥–µ–ª—å –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤—ñ–¥ –≥–æ—Å—Ç—è"""
    _collection_name = 'registration_requests'
    
    STATUS_CHOICES = [
        ('pending', '–û—á—ñ–∫—É—î —Ä–æ–∑–≥–ª—è–¥—É'),
        ('approved', '–°—Ö–≤–∞–ª–µ–Ω–æ'),
        ('rejected', '–í—ñ–¥—Ö–∏–ª–µ–Ω–æ')
    ]
    
    username = orm.StringField(required=True, max_length=50)
    email = orm.EmailField(required=True)
    message = orm.StringField()  # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    status = orm.StringField(choices=STATUS_CHOICES, default='pending')
    reviewed_by = orm.ReferenceField(User)  # –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä, —è–∫–∏–π —Ä–æ–∑–≥–ª—è–Ω—É–≤
    reviewed_at = orm.DateTimeField()
    created_at = orm.DateTimeField(default=datetime.now)
    
    def to_dict(self, serialize=True):
        data = super().to_dict(serialize)
        return data
```

**–ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä–∏—Ç–∏ permissions –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ä–æ–ª–µ–π**

```python
# apps/api/authentication/permissions.py - –†–û–ó–®–ò–†–ò–¢–ò

from rest_framework.permissions import BasePermission, SAFE_METHODS

class IsAdminOrReadOnly(BasePermission):
    """GET ‚Äî –¥–æ–∑–≤–æ–ª–µ–Ω–æ –≤—Å—ñ–º, POST/PUT/DELETE ‚Äî —Ç—ñ–ª—å–∫–∏ operator"""
    def has_permission(self, request, view):
        if request.method in SAFE_METHODS:
            return True
        user = getattr(request, "user", None)
        if not user or not getattr(user, "is_authenticated", False):
            return False
        return user.role == "operator"


class IsAdmin(BasePermission):
    """–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä"""
    def has_permission(self, request, view):
        user = getattr(request, "user", None)
        if not user or not getattr(user, "is_authenticated", False):
            return False
        return user.role == "admin"


class IsOperator(BasePermission):
    """–û–ø–µ—Ä–∞—Ç–æ—Ä –∞–±–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä"""
    def has_permission(self, request, view):
        user = getattr(request, "user", None)
        if not user or not getattr(user, "is_authenticated", False):
            return False
        return user.role in ["operator", "admin"]


class IsAuthorized(BasePermission):
    """–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (user, operator, admin)"""
    def has_permission(self, request, view):
        user = getattr(request, "user", None)
        if not user or not getattr(user, "is_authenticated", False):
            return False
        return user.role in ["user", "operator", "admin"]


class IsGuestOrAuthorized(BasePermission):
    """–ì—ñ—Å—Ç—å –∞–±–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π (–¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)"""
    def has_permission(self, request, view):
        if request.method in SAFE_METHODS:
            return True  # –ì—ñ—Å—Ç—å –º–æ–∂–µ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏
        user = getattr(request, "user", None)
        if not user:
            return False
        return user.is_authenticated
```

**–ö—Ä–æ–∫ 4: –î–æ–¥–∞—Ç–∏ endpoints –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é**

```python
# apps/api/views/registration_views.py
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny, IsAdmin
from rest_framework.response import Response
from rest_framework import status
from apps.main.models import User, RegistrationRequest
from datetime import datetime

@api_view(['POST'])
@permission_classes([AllowAny])  # –ì—ñ—Å—Ç—å –º–æ–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É
def submit_registration_request(request):
    """
    –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é (–¥–ª—è –≥–æ—Å—Ç–µ–π)
    """
    username = request.data.get('username', '').strip()
    email = request.data.get('email', '').strip()
    message = request.data.get('message', '').strip()
    
    if not username or not email:
        return Response({
            'success': False,
            'error': '–ü–æ–ª—è username —Ç–∞ email –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –Ω–µ —ñ—Å–Ω—É—î –≤–∂–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
    existing_user = User.objects().filter(username=username).first()
    if existing_user:
        return Response({
            'success': False,
            'error': '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º username –≤–∂–µ —ñ—Å–Ω—É—î'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    existing_email = User.objects().filter(email=email).first()
    if existing_email:
        return Response({
            'success': False,
            'error': '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –Ω–µ–º–∞—î –≤–∂–µ –∑–∞—è–≤–∫–∏
    existing_request = RegistrationRequest.objects().filter(
        username=username,
        status='pending'
    ).first()
    if existing_request:
        return Response({
            'success': False,
            'error': '–ó–∞—è–≤–∫–∞ –∑ —Ç–∞–∫–∏–º username –≤–∂–µ –æ—á—ñ–∫—É—î —Ä–æ–∑–≥–ª—è–¥—É'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞—è–≤–∫—É
    reg_request = RegistrationRequest.create(
        username=username,
        email=email,
        message=message,
        status='pending',
        created_at=datetime.now()
    )
    
    return Response({
        'success': True,
        'message': '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞. –û—á—ñ–∫—É–π—Ç–µ —Ä–æ–∑–≥–ª—è–¥—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.',
        'request_id': str(reg_request._id)
    })


@api_view(['GET'])
@permission_classes([IsAdmin])
def list_registration_requests(request):
    """
    –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
    """
    status_filter = request.GET.get('status', 'pending')
    
    requests = RegistrationRequest.objects().filter(status=status_filter).order_by('-created_at').all()
    
    result = []
    for req in requests:
        result.append({
            'id': str(req._id),
            'username': req.username,
            'email': req.email,
            'message': req.message,
            'status': req.status,
            'created_at': req.created_at.isoformat() if req.created_at else None,
            'reviewed_at': req.reviewed_at.isoformat() if req.reviewed_at else None
        })
    
    return Response({
        'success': True,
        'data': result,
        'count': len(result)
    })


@api_view(['POST'])
@permission_classes([IsAdmin])
def approve_registration_request(request, request_id):
    """
    –°—Ö–≤–∞–ª–∏—Ç–∏ –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
    """
    reg_request = RegistrationRequest.find_by_id(request_id)
    
    if not reg_request:
        return Response({
            'success': False,
            'error': '–ó–∞—è–≤–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞'
        }, status=status.HTTP_404_NOT_FOUND)
    
    if reg_request.status != 'pending':
        return Response({
            'success': False,
            'error': f'–ó–∞—è–≤–∫–∞ –≤–∂–µ {reg_request.status}'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    password = request.data.get('password', '')  # –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –ø–∞—Ä–æ–ª—å
    if not password:
        return Response({
            'success': False,
            'error': '–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    user = User.create(
        username=reg_request.username,
        email=reg_request.email,
        role='user',  # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 'user'
        is_active=True
    )
    user.set_password(password)
    user.save()
    
    # –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞—è–≤–∫—É
    reg_request.status = 'approved'
    reg_request.reviewed_by = request.user.id
    reg_request.reviewed_at = datetime.now()
    reg_request.save()
    
    return Response({
        'success': True,
        'message': '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π',
        'user_id': str(user._id)
    })


@api_view(['POST'])
@permission_classes([IsAdmin])
def reject_registration_request(request, request_id):
    """
    –í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
    """
    reg_request = RegistrationRequest.find_by_id(request_id)
    
    if not reg_request:
        return Response({
            'success': False,
            'error': '–ó–∞—è–≤–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞'
        }, status=status.HTTP_404_NOT_FOUND)
    
    if reg_request.status != 'pending':
        return Response({
            'success': False,
            'error': f'–ó–∞—è–≤–∫–∞ –≤–∂–µ {reg_request.status}'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    reason = request.data.get('reason', '')
    
    # –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞—è–≤–∫—É
    reg_request.status = 'rejected'
    reg_request.reviewed_by = request.user.id
    reg_request.reviewed_at = datetime.now()
    if reason:
        reg_request.message = f"{reg_request.message or ''}\n\n–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: {reason}"
    reg_request.save()
    
    return Response({
        'success': True,
        'message': '–ó–∞—è–≤–∫–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞'
    })
```

**–ö—Ä–æ–∫ 5: –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö endpoints**

```python
# –ü—Ä–∏–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è apps/api/views/queries_views.py

# –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (user, operator, admin)
@api_view(['GET'])
@permission_classes([IsAuthorized])  # –ó–ê–ú–Ü–°–¢–¨ IsAuthenticated
def query1_suppliers_with_products(request):
    # ... –∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω

# –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤ (–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤)
@api_view(['POST'])
@permission_classes([IsOperator])  # –¢—ñ–ª—å–∫–∏ operator —Ç–∞ admin
def execute_custom_aggregation(request):
    # ... –∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω

# –î–ª—è –≤—Å—ñ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö (–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤)
@api_view(['POST'])
@permission_classes([IsAuthorized])  # user, operator, admin
def execute_builtin_query(request):
    # ... –∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω, –∞–ª–µ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
```

---

## üìã –ü–†–ê–í–ê –î–û–°–¢–£–ü–£ –ó–ì–Ü–î–ù–û –ó –ú–ï–¢–û–î–ò–ß–ö–û–Æ

### –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –°–î (role='admin'):
- ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤–µ—Å—å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤
- ‚úÖ –î–æ–¥–∞–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ –°–î
- ‚úÖ –†–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø—ñ—Å–ª—è –∑–∞—è–≤–æ–∫
- ‚úÖ –í—ñ–¥—Ö–∏–ª—è—Ç–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
- ‚úÖ –§–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ SQL-–∑–∞–ø–∏—Ç–∏/–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó

### –û–ø–µ—Ä–∞—Ç–æ—Ä –°–î (role='operator'):
- ‚úÖ –î–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏, —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏, –≤–∏–¥–∞–ª—è—Ç–∏ –¥–∞–Ω—ñ
- ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤–±—É–¥–æ–≤–∞–Ω—ñ SQL-–∑–∞–ø–∏—Ç–∏/–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
- ‚úÖ –§–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ SQL-–∑–∞–ø–∏—Ç–∏/–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
- ‚ùå –ù–ï –º–æ–∂–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤
- ‚ùå –ù–ï –º–æ–∂–µ —Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

### –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π (role='user'):
- ‚úÖ –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Ç–∞ –∑–¥—ñ–π—Å–Ω—é–≤–∞—Ç–∏ –ø–æ—à—É–∫ –¥–∞–Ω–∏—Ö
- ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤–±—É–¥–æ–≤–∞–Ω—ñ SQL-–∑–∞–ø–∏—Ç–∏/–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
- ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö SQL-–∑–∞–ø–∏—Ç—ñ–≤/–∞–≥—Ä–µ–≥–∞—Ü—ñ–π
- ‚ùå –ù–ï –º–æ–∂–µ —Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –∑–∞–ø–∏—Ç–∏
- ‚ùå –ù–ï –º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏/–≤–∏–¥–∞–ª—è—Ç–∏ –¥–∞–Ω—ñ

### –ì—ñ—Å—Ç—å (role='guest'):
- ‚úÖ –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –¥–∞–Ω—ñ –°–î (—Ç—ñ–ª—å–∫–∏ GET –∑–∞–ø–∏—Ç–∏)
- ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
- ‚ùå –ù–ï –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏
- ‚ùå –ù–ï –º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ

---

## üîß –ö–û–ù–ö–†–ï–¢–ù–Ü –ö–†–û–ö–ò –î–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª–∏
1. `apps/api/views/queries_views.py` - 10 –∑–∞–ø–∏—Ç—ñ–≤
2. `apps/api/urls/queries_urls.py` - URLs –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤
3. `apps/api/views/query_executor_views.py` - –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤
4. `apps/api/urls/query_executor_urls.py` - URLs –¥–ª—è executor
5. `apps/api/views/registration_views.py` - –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
6. `apps/api/models.py` - SavedQuery, RegistrationRequest (–∞–±–æ –¥–æ–¥–∞—Ç–∏ –≤ main/models.py)

### –ö—Ä–æ–∫ 2: –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ —Ñ–∞–π–ª–∏
1. `apps/main/models.py` - –¥–æ–¥–∞—Ç–∏ —Ä–æ–ª—å 'guest', –¥–æ–¥–∞—Ç–∏ RegistrationRequest, SavedQuery
2. `apps/api/authentication/permissions.py` - –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ permissions
3. `apps/api/urls/__init__.py` - –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –Ω–æ–≤—ñ URLs
4. `apps/api/views/user_views.py` - –º–æ–∂–ª–∏–≤–æ –¥–æ–¥–∞—Ç–∏ endpoint –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥–æ—Å—Ç—è

### –ö—Ä–æ–∫ 3: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ 10 –∑–∞–ø–∏—Ç—ñ–≤
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ä–æ–ª–µ–π
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é

---

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–Ü –ó–ê–£–í–ê–ñ–ï–ù–ù–Ø

1. **–ë–µ–∑–ø–µ–∫–∞**: –ü—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ –∫–∞—Å—Ç–æ–º–Ω–∏—Ö aggregation –∑–∞–ø–∏—Ç—ñ–≤ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ –∫–æ–ª–µ–∫—Ü—ñ—ó
2. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è**: –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤—Å—ñ –≤—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
3. **–ü–æ–º–∏–ª–∫–∏**: –û–±—Ä–æ–±–ª—è—Ç–∏ –≤—Å—ñ –º–æ–∂–ª–∏–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
4. **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**: –î–ª—è –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é
5. **ORM**: –í—Å—ñ –∑–∞–ø–∏—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —ñ—Å–Ω—É—é—á–∏–π ORM –∑ `core.mongo_orm`. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥—Ç—Ä–∏–º–∫—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤ (`__gte`, `__lte`, `__in`, `__icontains`)
6. **–ú–æ–¥–µ–ª—ñ**: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å—ñ –ø–æ–ª—è –º–æ–¥–µ–ª–µ–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–º —É –∫–æ–¥—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `Repair.status` –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è 'returned')
7. **CustomBuild**: –£ –º–æ–¥–µ–ª—ñ `Sale` –ø–æ–ª–µ `custom_build_service` –º–∞—î —Ç–∏–ø `CustomBuildConfig`, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç—å `purchased` (bool) —Ç–∞ `data` (CustomBuild)

## üìù –î–û–î–ê–¢–ö–û–í–Ü –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –î–õ–Ø –ö–û–î–£

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 1: –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ `__in` –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤ —É filter

ORM –ø—ñ–¥—Ç—Ä–∏–º—É—î `__in`, –∞–ª–µ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
.filter(status__in=['received', 'diagnosed', 'repairing'])

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
.filter(status=['received', 'diagnosed', 'repairing'])
```

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 2: –†–æ–±–æ—Ç–∞ –∑ ReferenceField

–ü—Ä–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –∑–∞ ReferenceField, ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç—É—î —Å—Ç—Ä–æ–∫–∏ –≤ ObjectId:
```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
.filter(user_id=user_id)  # user_id –º–æ–∂–µ –±—É—Ç–∏ str –∞–±–æ ObjectId

# –î–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –∫—ñ–ª—å–∫–æ–º–∞:
.filter(user_id__in=[user_id1, user_id2])  # –≤—Å—ñ –º–∞—é—Ç—å –±—É—Ç–∏ str –∞–±–æ ObjectId
```

### –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 3: –†–æ–±–æ—Ç–∞ –∑ EmbeddedField

–ü—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ –¥–æ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –ø–æ–ª—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `CustomBuildConfig.data`):
```python
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ:
if sale.custom_build_service and hasattr(sale.custom_build_service, 'purchased'):
    # ...

# –î–æ—Å—Ç—É–ø –¥–æ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö:
custom_build = sale.custom_build_service.data if hasattr(sale.custom_build_service, 'data') else None
```

---

*–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: 2025-01-27*
*–í–µ—Ä—Å—ñ—è: 1.0*

